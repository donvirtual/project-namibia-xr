<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr. Oma's Expeditie - FINALE</title>

    <!-- A-Frame Core -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <!-- A-Frame Extras (Animation Support) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Arial Black', sans-serif;
        }
        #overlay {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #FFD700;
            font-family: 'Arial Black', sans-serif;
            font-size: 28px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 1);
            z-index: 1000;
            pointer-events: none;
        }
        #hud {
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 20px;
            border: 5px solid #FFD700;
            max-width: 500px;
            backdrop-filter: blur(15px);
        }
        .level-title {
            color: #FF6347;
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .objective {
            color: #00FF00;
            font-size: 24px;
            margin: 15px 0;
        }
        .progress {
            color: #87CEEB;
            font-size: 32px;
            font-weight: bold;
        }
        #skip-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 20px 40px;
            background: linear-gradient(135deg, #FF6347, #FF4500);
            border: 4px solid #FFD700;
            border-radius: 15px;
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 8px 25px rgba(0,0,0,0.7);
            transition: all 0.3s;
        }
        #skip-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 40px rgba(255,99,71,0.9);
        }
    </style>
</head>
<body>
    <div id="overlay">
        <div id="hud">
            <div class="level-title" id="level-title">üåç DR. OMA'S EXPEDITIE</div>
            <div class="objective" id="objective">Namibian Steppe wordt geladen...</div>
            <div class="progress" id="progress"></div>
        </div>
    </div>

    <button id="skip-btn" onclick="window.gameManager.skipLevel()">‚è≠Ô∏è SKIP LEVEL</button>

    <a-scene
        webxr="requiredFeatures: hand-tracking; optionalFeatures: hit-test;"
        cursor="rayOrigin: mouse"
        renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true; shadows: true"
        shadow="type: pcf; autoUpdate: true"
        loading-screen="dotsColor: #FFD700; backgroundColor: #1a1a1a">

        <!-- =====================================================
             ASSET MANAGEMENT
             ===================================================== -->
        <a-assets>
            <!-- Characters -->
            <a-asset-item id="rhino-asset" src="assets/rhino.glb" response-type="arraybuffer"></a-asset-item>
            <a-asset-item id="hunter-asset" src="assets/hunter.glb" response-type="arraybuffer"></a-asset-item>

            <!-- Grazing Animals (Animated) -->
            <a-asset-item id="deer-asset" src="assets/deer.gltf" response-type="arraybuffer"></a-asset-item>
            <a-asset-item id="stag-asset" src="assets/stag.gltf" response-type="arraybuffer"></a-asset-item>
            <a-asset-item id="bull-asset" src="assets/bull.gltf" response-type="arraybuffer"></a-asset-item>
            <a-asset-item id="horse-asset" src="assets/horse.gltf" response-type="arraybuffer"></a-asset-item>
            <a-asset-item id="fox-asset" src="assets/fox.gltf" response-type="arraybuffer"></a-asset-item>
            <a-asset-item id="giraffe-asset" src="assets/giraffe.glb" response-type="arraybuffer"></a-asset-item>

            <!-- Environment -->
            <a-asset-item id="tree-asset" src="assets/Acacia.glb?v=2" response-type="arraybuffer"></a-asset-item>

            <!-- Textures -->
            <img id="sky-asset" src="assets/pexels-francesco-ungaro-998641.jpg?v=5" crossorigin="anonymous">
            <img id="ground-asset" src="assets/Ground096B_1K-JPG/Ground096B_1K-JPG_Color.jpg?v=3" crossorigin="anonymous">
        </a-assets>

        <!-- =====================================================
             ENVIRONMENT
             ===================================================== -->

        <!-- Skybox (360¬∞ Rotating Starry Night) -->
        <a-sky
            src="#sky-asset"
            rotation="0 -90 0"
            animation="property: rotation; to: 0 270 0; dur: 240000; easing: linear; loop: true">
        </a-sky>

        <!-- Procedural Wavy Terrain (Rolling Dunes) -->
        <a-plane
            id="ground"
            position="0 -0.1 0"
            rotation="-90 0 0"
            width="100"
            height="100"
            segments-width="64"
            segments-height="64"
            material="src: #ground-asset; color: #d2b48c; repeat: 40 40; roughness: 1; metalness: 0.0"
            shadow="receive: true"
            terrain-generator>
        </a-plane>

        <!-- Sand Fog REMOVED per user request -->

        <!-- =====================================================
             LIGHTING (NIGHT MODE - Namibian Starlight)
             ===================================================== -->

        <!-- Moon Light (Directional - casts shadows) -->
        <a-entity
            light="type: directional;
                   color: #AADDEE;
                   intensity: 0.8;
                   castShadow: true;
                   shadowBias: -0.001;
                   shadowMapWidth: 2048;
                   shadowMapHeight: 2048;
                   shadowCameraFar: 100;
                   shadowCameraLeft: -40;
                   shadowCameraRight: 40;
                   shadowCameraTop: 40;
                   shadowCameraBottom: -40"
            position="-20 25 10">
        </a-entity>

        <!-- Ambient (Warm night atmosphere) -->
        <a-entity
            light="type: ambient;
                   color: #443333;
                   intensity: 0.6">
        </a-entity>

        <!-- Campfire/Torch Light (Warm orange glow) -->
        <a-entity
            light="type: point;
                   color: #FFaa00;
                   intensity: 1.2;
                   distance: 5"
            position="2 1 -1">
        </a-entity>

        <!-- =====================================================
             CAMERA & CONTROLS
             ===================================================== -->

        <a-entity id="rig" position="0 0 0">
            <a-camera
                id="camera"
                position="0 1.6 5"
                look-controls
                wasd-controls="acceleration: 20">
                <!-- GAZE CURSOR: Kijken om te selecteren (FUSE mode: 2 seconden kijken = klik) -->
                <a-cursor
                    id="gaze-cursor"
                    color="#FFD700"
                    opacity="0.8"
                    raycaster="objects: .clickable; far: 150"
                    fuse="true"
                    fuse-timeout="2000"
                    animation__fusing="property: scale; startEvents: fusing; dur: 2000; from: 1 1 1; to: 0.2 0.2 0.2; easing: easeInQuad"
                    animation__click="property: scale; startEvents: click; dur: 150; from: 0.2 0.2 0.2; to: 1 1 1; easing: easeOutQuad">
                </a-cursor>
            </a-camera>

            <!-- LEFT HAND (NATIVE HAND TRACKING - NO CONTROLLERS) -->
            <a-entity
                id="left-hand"
                hand-tracking-controls="hand: left"
                position="-0.3 1.4 -0.4">
                <!-- Shield voor Level 2 (volgt hand positie exact) -->
                <a-entity
                    id="shield"
                    visible="false"
                    geometry="primitive: cylinder; radius: 0.5; height: 0.05"
                    material="color: #4169E1; metalness: 0.8; roughness: 0.2; emissive: #1E90FF; emissiveIntensity: 0.5; opacity: 0.9; transparent: true"
                    rotation="90 0 0"
                    shadow="cast: true">
                </a-entity>
            </a-entity>

            <!-- RIGHT HAND (NATIVE HAND TRACKING - NO CONTROLLERS) -->
            <a-entity
                id="right-hand"
                hand-tracking-controls="hand: right">
            </a-entity>
        </a-entity>

        <!-- =====================================================
             GAME MANAGER
             ===================================================== -->

        <a-entity id="game-manager" final-game-manager grazing-animals nature-populator hand-shield-sync></a-entity>

    </a-scene>

    <script>
        // =====================================================
        // AUDIO ENGINE (Enhanced)
        // =====================================================
        class FinalAudioEngine {
            constructor() {
                this.context = new (window.AudioContext || window.webkitAudioContext)();
                this.masterGain = this.context.createGain();
                this.masterGain.gain.value = 0.5;
                this.masterGain.connect(this.context.destination);
            }

            playPing() { this.playTone('sine', 800, 0.15, 0.15); }
            playHit() { this.playTone('square', 900, 0.2, 0.1); }
            playBlock() { this.playTone('triangle', 700, 0.3, 0.25); }
            playDamage() { this.playTone('sawtooth', 120, 0.35, 0.5); }
            playDrumBeat() { this.playTone('sawtooth', 50, 0.3, 0.18); }

            playSuccess() {
                const melody = [523.25, 659.25, 783.99, 1046.50];
                this.playMelody(melody, 180);
            }

            playVictory() {
                const melody = [523.25, 587.33, 659.25, 783.99, 880.00, 1046.50, 1174.66, 1318.51];
                this.playMelody(melody, 220);
            }

            playTone(type, freq, gain, duration) {
                const osc = this.context.createOscillator();
                const gainNode = this.context.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                gainNode.gain.setValueAtTime(gain, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + duration);
                osc.connect(gainNode);
                gainNode.connect(this.masterGain);
                osc.start();
                osc.stop(this.context.currentTime + duration);
            }

            playMelody(notes, interval) {
                notes.forEach((freq, i) => {
                    setTimeout(() => this.playTone('sine', freq, 0.18, 1.0), i * interval);
                });
            }

            resume() {
                if (this.context.state === 'suspended') this.context.resume();
            }
        }

        const audioEngine = new FinalAudioEngine();

        // =====================================================
        // PHYSICS SYSTEM
        // =====================================================
        class PhysicsSystem {
            constructor() {
                this.gravity = -9.8;
            }

            applyGravity(entity, velocity, deltaTime) {
                velocity.y += this.gravity * deltaTime;

                const pos = entity.getAttribute('position');
                pos.x += velocity.x * deltaTime;
                pos.y += velocity.y * deltaTime;
                pos.z += velocity.z * deltaTime;

                entity.setAttribute('position', pos);

                // Rotate to face movement direction
                const angle = Math.atan2(velocity.y, Math.sqrt(velocity.x * velocity.x + velocity.z * velocity.z));
                const rotation = entity.getAttribute('rotation');
                rotation.x = THREE.MathUtils.radToDeg(angle);
                entity.setAttribute('rotation', rotation);

                return pos.y <= 0;
            }
        }

        const physics = new PhysicsSystem();

        // =====================================================
        // HAND TRACKING SHIELD SYNC
        // =====================================================
        AFRAME.registerComponent('hand-shield-sync', {
            init: function() {
                this.shield = document.getElementById('shield');
                this.leftHand = document.getElementById('left-hand');
                console.log('ü§ö Hand-shield sync initialized');
            },

            tick: function() {
                // Sync shield position with left hand real-time
                if (this.leftHand && this.shield && this.shield.getAttribute('visible')) {
                    const handPos = this.leftHand.object3D.position;
                    const handRot = this.leftHand.object3D.rotation;

                    // Update shield to exactly follow hand
                    this.shield.object3D.position.copy(handPos);
                    this.shield.object3D.rotation.copy(handRot);
                }
            }
        });

        // =====================================================
        // PROCEDURAL WAVY TERRAIN (ROLLING DUNES)
        // =====================================================
        AFRAME.registerComponent('terrain-generator', {
            init: function() {
                console.log('üèúÔ∏è Generating wavy terrain (rolling dunes)...');

                // Wait for geometry to be loaded
                this.el.addEventListener('loaded', () => {
                    this.generateWaves();
                });
            },

            generateWaves: function() {
                const mesh = this.el.getObject3D('mesh');
                if (!mesh) {
                    console.warn('No mesh found for terrain');
                    return;
                }

                const geometry = mesh.geometry;
                const vertices = geometry.attributes.position;

                // Apply sine wave displacement to create rolling dunes
                for (let i = 0; i < vertices.count; i++) {
                    const x = vertices.getX(i);
                    const y = vertices.getY(i);

                    // Math magic: Sine wave formula for gentle dunes
                    // z = sin(x/5) * cos(y/5) * amplitude
                    const z = Math.sin(x / 5) * Math.cos(y / 5) * 1.5;

                    vertices.setZ(i, z);
                }

                // Mark geometry as updated
                vertices.needsUpdate = true;
                geometry.computeVertexNormals(); // Recalculate lighting normals

                console.log('‚úì Wavy terrain generated with rolling dunes');
            }
        });

        // =====================================================
        // GRAZING ANIMALS COMPONENT (ANIMATED)
        // =====================================================
        AFRAME.registerComponent('grazing-animals', {
            init: function() {
                console.log('ü¶å Spawning ANIMATED grazing animals...');

                setTimeout(() => {
                    this.spawnAnimals();
                    this.spawnRunningGiraffe();
                }, 2000);
            },

            spawnAnimals: function() {
                // Check if we have animal assets (EXCLUDE giraffe - he gets special treatment)
                const animalTypes = ['deer', 'stag', 'bull', 'horse', 'fox'];
                const availableAnimals = animalTypes.filter(type =>
                    !!document.getElementById(`${type}-asset`)
                );

                if (availableAnimals.length === 0) {
                    console.log('No animal models found, skipping grazing animals');
                    return;
                }

                console.log(`Found ${availableAnimals.length} animal types:`, availableAnimals);

                const animalCount = 12; // More animals for variety

                for (let i = 0; i < animalCount; i++) {
                    // RANDOM PLACEMENT (NOT CIRCLE!)
                    // x: -30 to 30
                    // z: -30 to -10 (behind camera)
                    const x = -30 + Math.random() * 60;
                    const z = -30 + Math.random() * 20;

                    // Pick random animal type
                    const animalType = availableAnimals[Math.floor(Math.random() * availableAnimals.length)];

                    const animal = document.createElement('a-entity');
                    animal.setAttribute('gltf-model', `#${animalType}-asset`);
                    animal.setAttribute('position', `${x} 0 ${z}`);

                    // Random rotation (0-360¬∞)
                    animal.setAttribute('rotation', `0 ${Math.random() * 360} 0`);

                    // Corrected scale for grazing animals
                    animal.setAttribute('scale', '0.2 0.2 0.2');

                    // Enable animation-mixer to play GLTF animations
                    animal.setAttribute('animation-mixer', 'clip: *; loop: repeat');

                    // Slow wandering animation
                    animal.setAttribute('animation__wander', {
                        property: 'rotation',
                        to: `0 ${Math.random() * 360} 0`,
                        dur: 20000 + Math.random() * 15000,
                        loop: true,
                        dir: 'alternate',
                        easing: 'easeInOutQuad'
                    });

                    animal.setAttribute('shadow', 'cast: true; receive: true');

                    this.el.sceneEl.appendChild(animal);
                }

                console.log(`‚úì Spawned ${animalCount} ANIMATED animals (${availableAnimals.join(', ')})`);
            },

            spawnRunningGiraffe: function() {
                // Check if giraffe exists
                if (!document.getElementById('giraffe-asset')) {
                    console.log('No giraffe asset found');
                    return;
                }

                // Spawn giraffe VERY far away on the left
                const giraffe = document.createElement('a-entity');
                giraffe.setAttribute('gltf-model', '#giraffe-asset');

                // Start position: Far left (-60m) and far back (-50m)
                const startX = -60;
                const startZ = -50;

                // End position: Far right (60m) and in front (20m)
                const endX = 60;
                const endZ = 20;

                giraffe.setAttribute('position', `${startX} 0 ${startZ}`);
                giraffe.setAttribute('scale', '0.3 0.3 0.3');  // Slightly bigger than other animals

                // Rotation to face running direction
                const angle = Math.atan2(endZ - startZ, endX - startX);
                const rotationY = THREE.MathUtils.radToDeg(angle) - 90;
                giraffe.setAttribute('rotation', `0 ${rotationY} 0`);

                // Enable animation-mixer for running animation
                giraffe.setAttribute('animation-mixer', 'clip: *; loop: repeat');

                // RUNNING ANIMATION: Fast sprint across the scene (8 seconds)
                giraffe.setAttribute('animation', {
                    property: 'position',
                    to: `${endX} 0 ${endZ}`,
                    dur: 8000,  // 8 seconds = fast gallop
                    easing: 'linear',
                    loop: false
                });

                giraffe.setAttribute('shadow', 'cast: true; receive: true');

                this.el.sceneEl.appendChild(giraffe);

                console.log('‚úì Spawned running giraffe (sprinting from left to right)');

                // Respawn after it runs off screen (every 30 seconds)
                setInterval(() => {
                    giraffe.setAttribute('position', `${startX} 0 ${startZ}`);
                    giraffe.setAttribute('animation', {
                        property: 'position',
                        to: `${endX} 0 ${endZ}`,
                        dur: 8000,
                        easing: 'linear',
                        loop: false
                    });
                }, 30000);
            }
        });

        // =====================================================
        // NATURE PACK POPULATOR (DUNES DECORATION)
        // =====================================================
        AFRAME.registerComponent('nature-populator', {
            init: function() {
                console.log('üåø Populating dunes with nature objects...');

                setTimeout(() => {
                    this.populateDunes();
                }, 3000);
            },

            populateDunes: function() {
                const scene = this.el.sceneEl;

                // GRASS & ROCKS DELETED PER USER REQUEST

                // Dead trees (5x using existing tree asset if available)
                const hasTree = !!document.getElementById('tree-asset');
                for (let i = 0; i < 5; i++) {
                    if (hasTree) {
                        const tree = document.createElement('a-entity');
                        tree.setAttribute('gltf-model', '#tree-asset');
                        tree.setAttribute('position', `${this.randomX()} -0.5 ${this.randomZ()}`);
                        tree.setAttribute('scale', `${0.8 + Math.random() * 0.4} ${0.8 + Math.random() * 0.4} ${0.8 + Math.random() * 0.4}`);
                        tree.setAttribute('rotation', `0 ${Math.random() * 360} 0`);
                        tree.setAttribute('shadow', 'cast: true');
                        scene.appendChild(tree);
                    } else {
                        // Fallback: procedural dead tree
                        const trunk = document.createElement('a-cylinder');
                        trunk.setAttribute('position', `${this.randomX()} -0.5 ${this.randomZ()}`);
                        trunk.setAttribute('radius', '0.15');
                        trunk.setAttribute('height', '2.5');
                        trunk.setAttribute('color', '#3d2f1f');
                        trunk.setAttribute('roughness', '1');
                        trunk.setAttribute('shadow', 'cast: true');
                        scene.appendChild(trunk);
                    }
                }

                console.log('‚úì Populated dunes: 200 grass, 20 rocks, 5 trees');
            },

            randomX: function() {
                return -40 + Math.random() * 80; // -40 to 40
            },

            randomZ: function() {
                return -40 + Math.random() * 80; // -40 to 40
            },

            randomGrassColor: function() {
                const colors = ['#3a5f0b', '#4a6f1b', '#2d4f08', '#5a8f2b'];
                return colors[Math.floor(Math.random() * colors.length)];
            },

            randomRockColor: function() {
                const colors = ['#6b5a4d', '#8b7a6d', '#5b4a3d', '#7b6a5d'];
                return colors[Math.floor(Math.random() * colors.length)];
            }
        });

        // =====================================================
        // GAME STATES
        // =====================================================
        const GAME_STATES = {
            INTRO: 'intro',
            LEVEL_1: 'level_1',
            LEVEL_2: 'level_2',
            LEVEL_3: 'level_3',
            VICTORY: 'victory'
        };

        // =====================================================
        // FINAL GAME MANAGER
        // =====================================================
        AFRAME.registerComponent('final-game-manager', {
            init: function() {
                this.currentState = GAME_STATES.INTRO;
                this.level1Target = 1; // Only need to find Namibi√´!
                this.level2Score = 0;
                this.level2Target = 5;
                this.level3Complete = false;

                this.activeObjects = [];
                this.physicsObjects = [];
                this.camera = document.querySelector('#camera');
                this.shield = document.querySelector('#shield');

                // Asset availability
                this.hasRhino = !!document.getElementById('rhino-asset');
                this.hasHunter = !!document.getElementById('hunter-asset');

                window.gameManager = this;

                setTimeout(() => this.startIntro(), 2500);
            },

            tick: function(time, deltaTime) {
                const dt = deltaTime / 1000;

                // Physics for flying objects
                this.physicsObjects.forEach(obj => {
                    if (obj.userData && obj.userData.velocity) {
                        const hitGround = physics.applyGravity(obj, obj.userData.velocity, dt);

                        if (hitGround && obj.parentNode) {
                            obj.parentNode.removeChild(obj);
                            this.physicsObjects = this.physicsObjects.filter(o => o !== obj);
                        }
                    }
                });

                // Level 2: Shield collision detection
                if (this.currentState === GAME_STATES.LEVEL_2 && this.shield) {
                    this.checkShieldCollisions();
                }
            },

            skipLevel: function() {
                switch(this.currentState) {
                    case GAME_STATES.INTRO: this.startLevel1(); break;
                    case GAME_STATES.LEVEL_1: this.completeLevel1(); break;
                    case GAME_STATES.LEVEL_2: this.completeLevel2(); break;
                    case GAME_STATES.LEVEL_3: this.completeLevel3(); break;
                    case GAME_STATES.VICTORY: location.reload(); break;
                }
            },

            startIntro: function() {
                this.currentState = GAME_STATES.INTRO;
                this.updateHUD('üåç DR. OMA\'S EXPEDITIE', 'KLIK OM TE STARTEN', '');

                const panel = this.createClickablePanel(
                    'MISSIE BRIEFING\n\nWelkom Dokter!\n\n' +
                    '3D Assets Status:\n' +
                    (this.hasRhino ? '‚úì' : '‚úó') + ' Neushoorn\n' +
                    (this.hasHunter ? '‚úì' : '‚úó') + ' Jagers\n\n' +
                    'Niveau 1: Vind Namibi√´!\n' +
                    'Niveau 2: Blokkeer Speren\n' +
                    'Niveau 3: Rectaal Onderzoek\n\n' +
                    '>>> KLIK HIER OM TE STARTEN <<<',
                    '#00FF00',
                    5,
                    () => this.startLevel1()
                );
            },

            // =====================================================
            // LEVEL 1: THE TRAVELER'S MEMORY
            // =====================================================
            startLevel1: function() {
                this.currentState = GAME_STATES.LEVEL_1;
                this.clearAllObjects();

                this.updateHUD('‚úàÔ∏è NIVEAU 1: REISERVARING', 'Vind NAMIBI√ã!', '');

                const destinations = [
                    { name: 'Los Angeles', isTarget: false },
                    { name: 'Xian', isTarget: false },
                    { name: 'Jerusalem', isTarget: false },
                    { name: 'Hongarije', isTarget: false },
                    { name: 'Denemarken', isTarget: false },
                    { name: 'Texel', isTarget: false },
                    { name: 'NAMIBI√ã', isTarget: true },
                ];

                destinations.forEach((dest, i) => {
                    setTimeout(() => {
                        if (this.currentState === GAME_STATES.LEVEL_1) {
                            this.spawnGlobe(dest, (Math.PI * 2 / destinations.length) * i);
                        }
                    }, i * 600);
                });
            },

            spawnGlobe: function(destination, angle) {
                const globe = document.createElement('a-entity');

                const radius = 5;
                const height = 1.6;
                const x = Math.cos(angle) * radius;
                const z = Math.sin(angle) * radius;

                globe.setAttribute('position', `${x} ${height} ${z}`);
                globe.classList.add('globe', 'clickable');
                globe.setAttribute('data-name', destination.name);
                globe.setAttribute('data-is-target', destination.isTarget);

                // The Globe (Earth sphere)
                const sphere = document.createElement('a-sphere');
                sphere.setAttribute('radius', '0.5');
                sphere.setAttribute('color', destination.isTarget ? '#FFD700' : '#4169E1');
                sphere.setAttribute('metalness', '0.5');
                sphere.setAttribute('roughness', '0.4');
                sphere.setAttribute('shadow', 'cast: true');
                globe.appendChild(sphere);

                // Country Label
                const label = document.createElement('a-text');
                label.setAttribute('value', destination.name);
                label.setAttribute('align', 'center');
                label.setAttribute('color', destination.isTarget ? '#FF6347' : '#FFFFFF');
                label.setAttribute('width', '4');
                label.setAttribute('position', '0 0.9 0');
                label.setAttribute('look-at', '[camera]');
                globe.appendChild(label);

                // Rotation animation
                globe.setAttribute('animation', {
                    property: 'rotation',
                    to: '0 360 0',
                    dur: 12000,
                    loop: true,
                    easing: 'linear'
                });

                globe.addEventListener('click', () => this.handleGlobeClick(globe));

                this.el.sceneEl.appendChild(globe);
                this.activeObjects.push(globe);
            },

            handleGlobeClick: function(globe) {
                const isTarget = globe.getAttribute('data-is-target') === 'true';
                const name = globe.getAttribute('data-name');

                if (isTarget) {
                    // FOUND NAMIBI√ã!
                    audioEngine.playSuccess();
                    this.updateHUD('‚úàÔ∏è NIVEAU 1', `‚úì GEVONDEN: ${name}!`, '');
                    this.createExplosion(globe.object3D.position, '#FFD700', 60);

                    if (globe.parentNode) {
                        globe.parentNode.removeChild(globe);
                        this.activeObjects = this.activeObjects.filter(o => o !== globe);
                    }

                    setTimeout(() => this.completeLevel1(), 2000);
                } else {
                    // Already visited
                    audioEngine.playPing();

                    // Turn grey
                    const sphere = globe.querySelector('a-sphere');
                    sphere.setAttribute('color', '#808080');

                    // Change label
                    const label = globe.querySelector('a-text');
                    label.setAttribute('value', 'AL GEWEEST');
                    label.setAttribute('color', '#999999');

                    this.updateHUD('‚úàÔ∏è NIVEAU 1', `${name} - al geweest!`, '');
                }
            },

            completeLevel1: function() {
                this.clearAllObjects();
                audioEngine.playSuccess();
                this.updateHUD('‚úì NIVEAU 1 VOLTOOID!', 'Volgende missie...', '');
                setTimeout(() => this.startLevel2(), 2500);
            },

            // =====================================================
            // LEVEL 2: SHIELD DEFENSE
            // =====================================================
            startLevel2: function() {
                this.currentState = GAME_STATES.LEVEL_2;
                this.level2Score = 0;
                this.clearAllObjects();

                // Show shield
                if (this.shield) {
                    this.shield.setAttribute('visible', 'true');
                }

                this.updateHUD('üõ°Ô∏è NIVEAU 2: VERDEDIGING', 'Blokkeer speren met je LINKERHAND!', `${this.level2Score} / ${this.level2Target}`);

                this.level2DrumInterval = setInterval(() => {
                    if (this.currentState === GAME_STATES.LEVEL_2) {
                        audioEngine.playDrumBeat();
                    }
                }, 1000);

                // Spawn 3 bushes at 15m radius for ambush
                this.spawnAmbushBushes();

                // Spawn hunters in 2-3 formation next to each bush (9 total hunters)
                // 3 bushes √ó 2 rows √ó 3 cols = 18 hunters (maar we doen 2 rijen, laatste rij heeft 3)
                let hunterIndex = 0;
                for (let bushIndex = 0; bushIndex < 3; bushIndex++) {
                    for (let row = 0; row < 2; row++) {
                        const colsInRow = row === 0 ? 2 : 3;  // Front row: 2, back row: 3
                        for (let col = 0; col < colsInRow; col++) {
                            setTimeout(() => {
                                if (this.currentState === GAME_STATES.LEVEL_2) {
                                    this.spawnHunterWithSpear(bushIndex, row, col);
                                }
                            }, hunterIndex * 500);  // Stagger spawns by 0.5s
                            hunterIndex++;
                        }
                    }
                }
            },

            spawnAmbushBushes: function() {
                const bushRadius = 15;
                const bushCount = 3;

                for (let i = 0; i < bushCount; i++) {
                    const angle = (Math.PI * 2 / bushCount) * i;
                    const x = Math.cos(angle) * bushRadius;
                    const z = Math.sin(angle) * bushRadius;

                    // Create procedural bush (cluster of green spheres)
                    const bush = document.createElement('a-entity');
                    bush.setAttribute('position', `${x} 0 ${z}`);

                    // Main foliage (large green sphere)
                    const foliage1 = document.createElement('a-sphere');
                    foliage1.setAttribute('radius', '2');
                    foliage1.setAttribute('position', '0 1.5 0');
                    foliage1.setAttribute('color', '#2d5016');
                    foliage1.setAttribute('roughness', '1');
                    foliage1.setAttribute('shadow', 'cast: true; receive: true');
                    bush.appendChild(foliage1);

                    // Additional clusters for volume
                    const foliage2 = document.createElement('a-sphere');
                    foliage2.setAttribute('radius', '1.5');
                    foliage2.setAttribute('position', '-1 1 0.5');
                    foliage2.setAttribute('color', '#3a6b1e');
                    foliage2.setAttribute('roughness', '1');
                    bush.appendChild(foliage2);

                    const foliage3 = document.createElement('a-sphere');
                    foliage3.setAttribute('radius', '1.3');
                    foliage3.setAttribute('position', '1 0.8 -0.5');
                    foliage3.setAttribute('color', '#2d5016');
                    foliage3.setAttribute('roughness', '1');
                    bush.appendChild(foliage3);

                    // Trunk (brown cylinder)
                    const trunk = document.createElement('a-cylinder');
                    trunk.setAttribute('radius', '0.3');
                    trunk.setAttribute('height', '2');
                    trunk.setAttribute('position', '0 1 0');
                    trunk.setAttribute('color', '#4a3c28');
                    trunk.setAttribute('roughness', '1');
                    trunk.setAttribute('shadow', 'cast: true');
                    bush.appendChild(trunk);

                    this.el.sceneEl.appendChild(bush);
                    this.activeObjects.push(bush);
                }

                console.log(`‚úì Spawned ${bushCount} ambush bushes at ${bushRadius}m radius`);
            },

            spawnHunterWithSpear: function(bushIndex, row, col) {
                // Bush positions (same as spawnAmbushBushes)
                const bushRadius = 15;
                const bushAngle = (Math.PI * 2 / 3) * bushIndex;
                const bushX = Math.cos(bushAngle) * bushRadius;
                const bushZ = Math.sin(bushAngle) * bushRadius;

                // Position hunters 1m to the right of bush, in 2x3 grid
                // Calculate right vector (perpendicular to bush-to-center)
                const rightX = -Math.sin(bushAngle);  // Perpendicular vector
                const rightZ = Math.cos(bushAngle);

                // Grid formation: 2 rows, 3 cols (spaced 1.5m apart)
                const spacing = 1.5;
                const x = bushX + rightX * 1 + (col - 1) * spacing * rightX;
                const z = bushZ + rightZ * 1 + (col - 1) * spacing * rightZ - (row * spacing);
                const height = 0;

                // Calculate rotation to face camera (at 0,0,0)
                const angleToCamera = Math.atan2(-x, -z);  // Look at center
                const rotationY = THREE.MathUtils.radToDeg(angleToCamera);

                // Hunter model
                if (this.hasHunter) {
                    const hunter = document.createElement('a-entity');
                    hunter.setAttribute('gltf-model', '#hunter-asset');
                    hunter.setAttribute('position', `${x} ${height} ${z}`);
                    hunter.setAttribute('scale', '0.25 0.25 0.25');
                    hunter.setAttribute('rotation', `0 ${rotationY} 0`);  // Face camera!
                    hunter.setAttribute('shadow', 'cast: true');

                    // WALK SLOWLY TOWARDS CAMERA (as a group)
                    const targetDistance = 5;  // Stop at 5m from camera
                    const walkDuration = 30000;  // 30 seconds slow walk
                    const directionToCamera = Math.sqrt(x*x + z*z);  // Current distance
                    const walkRatio = targetDistance / directionToCamera;
                    const targetX = x * walkRatio;
                    const targetZ = z * walkRatio;

                    hunter.setAttribute('animation', {
                        property: 'position',
                        to: `${targetX} ${height} ${targetZ}`,
                        dur: walkDuration,
                        easing: 'linear'
                    });

                    this.el.sceneEl.appendChild(hunter);
                    this.activeObjects.push(hunter);
                }

                // Launch spear continuously (every 3 seconds)
                const spearInterval = setInterval(() => {
                    if (this.currentState === GAME_STATES.LEVEL_2) {
                        this.launchSpear(x, height + 1.5, z);
                    } else {
                        clearInterval(spearInterval);
                    }
                }, 3000 + Math.random() * 2000);  // 3-5 seconds between throws
            },

            launchSpear: function(startX, startY, startZ) {
                const spear = document.createElement('a-entity');

                spear.setAttribute('position', `${startX} ${startY} ${startZ}`);
                spear.classList.add('spear');
                spear.setAttribute('shadow', 'cast: true');

                // Spear visual (shaft + tip)
                const shaft = document.createElement('a-cylinder');
                shaft.setAttribute('radius', '0.05');
                shaft.setAttribute('height', '2.5');
                shaft.setAttribute('color', '#8B4513');
                shaft.setAttribute('rotation', '0 0 210');  // 90 + 120 = 210 degrees
                shaft.setAttribute('metalness', '0.2');
                shaft.setAttribute('roughness', '0.8');
                spear.appendChild(shaft);

                const tip = document.createElement('a-cone');
                tip.setAttribute('radius-bottom', '0.12');
                tip.setAttribute('height', '0.4');
                tip.setAttribute('color', '#C0C0C0');
                tip.setAttribute('position', '1.25 0 0');
                tip.setAttribute('rotation', '0 0 -90');
                tip.setAttribute('metalness', '0.9');
                tip.setAttribute('roughness', '0.2');
                spear.appendChild(tip);

                spear.setAttribute('look-at', '[camera]');

                // Physics: Fly towards camera
                const cameraPos = this.camera.object3D.position;
                const direction = new THREE.Vector3(
                    cameraPos.x - startX,
                    cameraPos.y - startY + 2,
                    cameraPos.z - startZ
                ).normalize();

                spear.userData = {
                    velocity: {
                        x: direction.x * 15,  // 3x faster/farther (was 5)
                        y: direction.y * 15 + 1.5,
                        z: direction.z * 15
                    },
                    isSpear: true
                };

                this.el.sceneEl.appendChild(spear);
                this.activeObjects.push(spear);
                this.physicsObjects.push(spear);
            },

            checkShieldCollisions: function() {
                if (!this.shield || !this.shield.object3D) return;

                const shieldPos = new THREE.Vector3();
                this.shield.object3D.getWorldPosition(shieldPos);

                this.physicsObjects.forEach(obj => {
                    if (obj.userData && obj.userData.isSpear && obj.parentNode) {
                        const spearPos = obj.object3D.position;
                        const distance = shieldPos.distanceTo(spearPos);

                        if (distance < 0.6) {
                            // BLOCKED!
                            this.level2Score++;
                            audioEngine.playBlock();
                            this.updateHUD('üõ°Ô∏è NIVEAU 2', '‚úì GEBLOKEERD!', `${this.level2Score} / ${this.level2Target}`);
                            this.createExplosion(spearPos, '#FFD700', 30);

                            obj.parentNode.removeChild(obj);
                            this.activeObjects = this.activeObjects.filter(o => o !== obj);
                            this.physicsObjects = this.physicsObjects.filter(o => o !== obj);

                            if (this.level2Score >= this.level2Target) {
                                this.completeLevel2();
                            }
                        }
                    }
                });
            },

            completeLevel2: function() {
                clearInterval(this.level2DrumInterval);
                if (this.shield) {
                    this.shield.setAttribute('visible', 'false');
                }
                this.clearAllObjects();
                audioEngine.playSuccess();
                this.updateHUD('‚úì NIVEAU 2 VOLTOOID!', 'Naar de operatiekamer...', '');
                setTimeout(() => this.startLevel3(), 2500);
            },

            // =====================================================
            // LEVEL 3: THE RECTAL EXAM
            // =====================================================
            startLevel3: function() {
                this.currentState = GAME_STATES.LEVEL_3;
                this.clearAllObjects();
                this.updateHUD('ü¶è NIVEAU 3: OPERATIE', 'RECTAAL ONDERZOEK!', '');
                this.spawnRhino();
            },

            spawnRhino: function() {
                const rhinoContainer = document.createElement('a-entity');
                rhinoContainer.setAttribute('id', 'rhino-boss');
                rhinoContainer.setAttribute('position', '0 0 -4');
                rhinoContainer.setAttribute('shadow', 'cast: true; receive: true');

                if (this.hasRhino) {
                    const rhino = document.createElement('a-entity');
                    rhino.setAttribute('gltf-model', '#rhino-asset');
                    rhino.setAttribute('scale', '2 2 2');
                    rhino.setAttribute('rotation', '0 200 0'); // REAR END PROPERLY FACING USER (20¬∞ offset)!

                    // Breathing animation
                    rhino.setAttribute('animation__breath', {
                        property: 'scale',
                        from: '2 2 2',
                        to: '2.05 2.05 2.05',
                        dur: 3500,
                        loop: true,
                        dir: 'alternate',
                        easing: 'easeInOutSine'
                    });

                    rhinoContainer.appendChild(rhino);
                } else {
                    // Fallback
                    const body = document.createElement('a-box');
                    body.setAttribute('width', '2');
                    body.setAttribute('height', '1.2');
                    body.setAttribute('depth', '1');
                    body.setAttribute('color', '#696969');
                    body.setAttribute('opacity', '0.6');
                    body.setAttribute('material', 'transparent: true; metalness: 0.3; roughness: 0.7');
                    body.setAttribute('rotation', '0 180 0');
                    rhinoContainer.appendChild(body);
                }

                // Tumor (at the REAR)
                const tumor = document.createElement('a-sphere');
                tumor.setAttribute('radius', '0.3');
                tumor.setAttribute('color', '#DC143C');
                tumor.setAttribute('position', '0 0.5 1.2'); // Rear position
                tumor.setAttribute('id', 'tumor');
                tumor.classList.add('tumor', 'clickable');
                tumor.setAttribute('material', 'emissive: #FF0000; emissiveIntensity: 1.0; metalness: 0.6; roughness: 0.2');
                tumor.setAttribute('shadow', 'cast: true');

                tumor.setAttribute('animation', {
                    property: 'scale',
                    from: '1 1 1',
                    to: '1.6 1.6 1.6',
                    dur: 1200,
                    loop: true,
                    dir: 'alternate',
                    easing: 'easeInOutSine'
                });

                tumor.addEventListener('click', () => this.handleTumorGrab(tumor));
                rhinoContainer.appendChild(tumor);

                // ARROW pointing at tumor
                const arrow = document.createElement('a-cone');
                arrow.setAttribute('radius-bottom', '0.2');
                arrow.setAttribute('height', '0.6');
                arrow.setAttribute('color', '#FFD700');
                arrow.setAttribute('position', '0 1.5 1.2');
                arrow.setAttribute('rotation', '180 0 0');
                arrow.setAttribute('material', 'emissive: #FFD700; emissiveIntensity: 0.8');

                arrow.setAttribute('animation__bounce', {
                    property: 'position',
                    to: '0 1.8 1.2',
                    dur: 800,
                    loop: true,
                    dir: 'alternate',
                    easing: 'easeInOutQuad'
                });

                rhinoContainer.appendChild(arrow);

                // LABEL
                const label = document.createElement('a-text');
                label.setAttribute('value', 'RECTAAL\nONDERZOEK\nSTARTEN');
                label.setAttribute('align', 'center');
                label.setAttribute('color', '#FFD700');
                label.setAttribute('width', '3');
                label.setAttribute('position', '1.5 1.5 1.2');
                label.setAttribute('look-at', '[camera]');
                rhinoContainer.appendChild(label);

                this.el.sceneEl.appendChild(rhinoContainer);
                this.activeObjects.push(rhinoContainer);
            },

            handleTumorGrab: function(tumor) {
                this.level3Complete = true;
                audioEngine.playSuccess();
                this.updateHUD('‚úì OPERATIE GESLAAGD!', 'Tumor verwijderd!', '');

                tumor.setAttribute('animation__extract', {
                    property: 'position',
                    to: '0 5 1.2',
                    dur: 2500,
                    easing: 'easeOutQuad'
                });

                tumor.setAttribute('animation__scale', {
                    property: 'scale',
                    to: '0 0 0',
                    dur: 2500,
                    easing: 'easeInQuad'
                });

                setTimeout(() => {
                    if (tumor.parentNode) tumor.parentNode.removeChild(tumor);
                    this.completeLevel3();
                }, 2500);
            },

            completeLevel3: function() {
                this.clearAllObjects();
                setTimeout(() => this.startVictory(), 2500);
            },

            // =====================================================
            // VICTORY SEQUENCE
            // =====================================================
            startVictory: function() {
                this.currentState = GAME_STATES.VICTORY;
                audioEngine.playVictory();
                this.updateHUD('üèÜ MISSIE VOLTOOID!', 'Alle levels uitgespeeld!', '');

                for (let i = 0; i < 12; i++) {
                    setTimeout(() => {
                        const pos = new THREE.Vector3(
                            (Math.random() - 0.5) * 10,
                            2 + Math.random() * 5,
                            -4 - Math.random() * 4
                        );
                        this.createExplosion(pos, ['#FFD700', '#FF6347', '#00FF00', '#87CEEB', '#FF69B4', '#FFA500'][i % 6], 80);
                    }, i * 800);
                }

                setTimeout(() => this.showFinalReward(), 5000);
            },

            showFinalReward: function() {
                const panel = document.createElement('a-entity');
                panel.setAttribute('position', '0 1.6 -5');
                panel.setAttribute('look-at', '[camera]');

                const bg = document.createElement('a-plane');
                bg.setAttribute('width', '5');
                bg.setAttribute('height', '3.5');
                bg.setAttribute('color', '#000000');
                bg.setAttribute('opacity', '0.95');
                bg.setAttribute('shadow', 'receive: true');
                panel.appendChild(bg);

                const border = document.createElement('a-plane');
                border.setAttribute('width', '5.2');
                border.setAttribute('height', '3.7');
                border.setAttribute('color', '#FFD700');
                border.setAttribute('opacity', '0.8');
                border.setAttribute('position', '0 0 -0.01');
                panel.appendChild(border);

                const title = document.createElement('a-text');
                title.setAttribute('value', 'üèÜ MISSIE VOLTOOID!');
                title.setAttribute('align', 'center');
                title.setAttribute('color', '#00FF00');
                title.setAttribute('width', '4.5');
                title.setAttribute('position', '0 1.3 0.02');
                panel.appendChild(title);

                const reward = document.createElement('a-text');
                reward.setAttribute('value', 'LOCATIE CADEAU:\n\n‚ú® IN DE ZANDBAK ‚ú®\n\n(Graaien maar, Oma!)');
                reward.setAttribute('align', 'center');
                reward.setAttribute('color', '#FFD700');
                reward.setAttribute('width', '4');
                reward.setAttribute('position', '0 0.3 0.02');
                reward.setAttribute('wrap-count', '35');
                panel.appendChild(reward);

                // 3D Book
                const book = document.createElement('a-box');
                book.setAttribute('width', '0.7');
                book.setAttribute('height', '0.9');
                book.setAttribute('depth', '0.15');
                book.setAttribute('color', '#8B4513');
                book.setAttribute('position', '0 -1.0 0.3');
                book.setAttribute('material', 'roughness: 0.9; metalness: 0.1');
                book.setAttribute('shadow', 'cast: true');

                book.setAttribute('animation__float', {
                    property: 'position',
                    to: '0 -0.7 0.3',
                    dur: 3500,
                    loop: true,
                    dir: 'alternate',
                    easing: 'easeInOutSine'
                });

                book.setAttribute('animation__rotate', {
                    property: 'rotation',
                    to: '0 360 0',
                    dur: 12000,
                    loop: true,
                    easing: 'linear'
                });

                panel.appendChild(book);

                this.el.sceneEl.appendChild(panel);
            },

            // =====================================================
            // UTILITIES
            // =====================================================
            updateHUD: function(title, objective, progress) {
                document.getElementById('level-title').textContent = title;
                document.getElementById('objective').textContent = objective;
                document.getElementById('progress').textContent = progress;
            },

            createClickablePanel: function(text, color, width, onClick) {
                const panel = document.createElement('a-entity');
                panel.setAttribute('position', '0 1.6 -4.5');
                panel.setAttribute('look-at', '[camera]');
                panel.classList.add('clickable');

                const bg = document.createElement('a-plane');
                bg.setAttribute('width', width);
                bg.setAttribute('height', '3.5');
                bg.setAttribute('color', '#000000');
                bg.setAttribute('opacity', '0.95');
                panel.appendChild(bg);

                const textEl = document.createElement('a-text');
                textEl.setAttribute('value', text);
                textEl.setAttribute('align', 'center');
                textEl.setAttribute('color', color);
                textEl.setAttribute('width', width - 0.6);
                textEl.setAttribute('position', '0 0 0.02');
                textEl.setAttribute('wrap-count', '50');
                panel.appendChild(textEl);

                panel.addEventListener('click', () => {
                    if (panel.parentNode) panel.parentNode.removeChild(panel);
                    if (onClick) onClick();
                });

                this.el.sceneEl.appendChild(panel);
                return panel;
            },

            createExplosion: function(position, color, count = 50) {
                for (let i = 0; i < count; i++) {
                    const particle = document.createElement('a-sphere');
                    particle.setAttribute('radius', 0.06 + Math.random() * 0.08);
                    particle.setAttribute('color', color);
                    particle.setAttribute('position', position);

                    const vx = (Math.random() - 0.5) * 5;
                    const vy = Math.random() * 4 + 1;
                    const vz = (Math.random() - 0.5) * 5;

                    particle.setAttribute('animation__pos', {
                        property: 'position',
                        to: `${position.x + vx} ${position.y + vy} ${position.z + vz}`,
                        dur: 1800,
                        easing: 'easeOutQuad'
                    });

                    particle.setAttribute('animation__scale', {
                        property: 'scale',
                        to: '0 0 0',
                        dur: 1800,
                        easing: 'easeInQuad'
                    });

                    this.el.sceneEl.appendChild(particle);
                    setTimeout(() => {
                        if (particle.parentNode) particle.parentNode.removeChild(particle);
                    }, 1800);
                }
            },

            flashScreen: function(color) {
                const flash = document.createElement('a-plane');
                flash.setAttribute('width', '100');
                flash.setAttribute('height', '100');
                flash.setAttribute('color', color);
                flash.setAttribute('opacity', '0.8');
                flash.setAttribute('position', '0 1.6 -1');

                flash.setAttribute('animation__fade', {
                    property: 'material.opacity',
                    from: 0.8,
                    to: 0,
                    dur: 900
                });

                this.el.sceneEl.appendChild(flash);
                setTimeout(() => {
                    if (flash.parentNode) flash.parentNode.removeChild(flash);
                }, 900);
            },

            clearAllObjects: function() {
                this.activeObjects.forEach(obj => {
                    if (obj.parentNode) obj.parentNode.removeChild(obj);
                });
                this.activeObjects = [];
                this.physicsObjects = [];
            }
        });

        document.addEventListener('click', () => audioEngine.resume(), { once: true });
    </script>
</body>
</html>
