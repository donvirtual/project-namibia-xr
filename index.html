<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibeke's Grote Expeditie - FINALE</title>

    <!-- A-Frame Core -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <!-- A-Frame Extras (Animation Support) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Courier New', monospace; overflow: hidden; }

        /* HUD Overlay (Desktop Only) */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 100;
        }

        #hud {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: #FFD700;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.9);
        }

        .level-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .objective {
            font-size: 1.2rem;
            color: #FFF;
        }

        .progress {
            font-size: 1.5rem;
            color: #FF6347;
            margin-top: 0.5rem;
        }

        #skip-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 0.8rem 1.5rem;
            background: rgba(255,99,71,0.8);
            color: #FFF;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            z-index: 200;
            pointer-events: all;
            transition: all 0.3s;
        }

        #skip-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 40px rgba(255,99,71,0.9);
        }
    </style>
</head>
<body>
    <!-- HUD Overlay (Desktop fallback) -->
    <div id="overlay">
        <div id="hud">
            <div class="level-title" id="level-title">üåç VIBEKE'S EXPEDITIE</div>
            <div class="objective" id="objective">Laden...</div>
            <div class="progress" id="progress"></div>
        </div>
    </div>

    <button id="skip-btn" onclick="window.gameManager && window.gameManager.skipLevel()">‚è≠Ô∏è SKIP</button>

    <a-scene
        webxr="referenceSpaceType: local-floor; optionalFeatures: hand-tracking"
        cursor="rayOrigin: mouse"
        renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true; shadows: true"
        shadow="type: pcf; autoUpdate: true"
        loading-screen="dotsColor: #FFD700; backgroundColor: #1a1a1a"
        vr-mode-ui="enabled: true"
        timeout="10000">

        <!-- =====================================================
             ASSET MANAGEMENT
             ===================================================== -->
        <a-assets timeout="15000">
            <!-- Characters -->
            <a-asset-item id="rhino-asset" src="assets/rhino.glb" response-type="arraybuffer"></a-asset-item>
            <a-asset-item id="hunter-asset" src="assets/hunter.glb" response-type="arraybuffer"></a-asset-item>

            <!-- NEW: User-provided assets -->
            <a-asset-item id="fly-model" src="assets/Fly.glb" response-type="arraybuffer"></a-asset-item>
            <a-asset-item id="heart-model" src="assets/bottle.glb" response-type="arraybuffer"></a-asset-item>

            <!-- AUDIO FILES -->
            <audio id="wind-loop" src="assets/desert-wind-1-350398.mp3" preload="auto"></audio>
            <audio id="insects-loop" src="assets/desert-insects-52089.mp3" preload="auto"></audio>
            <audio id="fart-sound" src="assets/wet-fart-6139.mp3" preload="auto"></audio>
            <audio id="squishy-loop" src="assets/wet-squishy-sound-34303.mp3" preload="auto" loop></audio>

            <!-- Grazing Animals (Animated) -->
            <a-asset-item id="deer-asset" src="assets/deer.gltf" response-type="arraybuffer"></a-asset-item>
            <a-asset-item id="stag-asset" src="assets/stag.gltf" response-type="arraybuffer"></a-asset-item>
            <a-asset-item id="bull-asset" src="assets/bull.gltf" response-type="arraybuffer"></a-asset-item>
            <a-asset-item id="horse-asset" src="assets/horse.gltf" response-type="arraybuffer"></a-asset-item>
            <a-asset-item id="fox-asset" src="assets/fox.gltf" response-type="arraybuffer"></a-asset-item>
            <a-asset-item id="giraffe-asset" src="assets/giraffe.glb" response-type="arraybuffer"></a-asset-item>

            <!-- Environment -->
            <a-asset-item id="tree-asset" src="assets/Acacia.glb?v=2" response-type="arraybuffer"></a-asset-item>

            <!-- Textures -->
            <img id="sky-asset" src="assets/pexels-francesco-ungaro-998641.jpg?v=5" crossorigin="anonymous">
            <img id="ground-asset" src="assets/Ground096B_1K-JPG/Ground096B_1K-JPG_Color.jpg?v=3" crossorigin="anonymous">
        </a-assets>

        <!-- =====================================================
             ENVIRONMENT
             ===================================================== -->

        <!-- Skybox (360¬∞ Rotating Starry Night) -->
        <a-sky
            src="#sky-asset"
            rotation="0 -90 0"
            animation="property: rotation; to: 0 270 0; dur: 240000; easing: linear; loop: true">
        </a-sky>

        <!-- Procedural Wavy Terrain (Rolling Dunes) -->
        <a-plane
            id="ground"
            position="0 -0.1 0"
            rotation="-90 0 0"
            width="100"
            height="100"
            segments-width="64"
            segments-height="64"
            material="src: #ground-asset; color: #d2b48c; repeat: 40 40; roughness: 1; metalness: 0.0"
            shadow="receive: true"
            terrain-generator>
        </a-plane>

        <!-- Floating Dust Particles -->
        <a-entity id="dust-particles" dust-system></a-entity>

        <!-- =====================================================
             LIGHTING (NIGHT MODE - Namibian Starlight)
             ===================================================== -->

        <!-- Moon Light (Directional - casts shadows) -->
        <a-entity
            light="type: directional;
                   color: #AADDEE;
                   intensity: 0.8;
                   castShadow: true;
                   shadowBias: -0.001;
                   shadowMapWidth: 2048;
                   shadowMapHeight: 2048;
                   shadowCameraFar: 100;
                   shadowCameraLeft: -40;
                   shadowCameraRight: 40;
                   shadowCameraTop: 40;
                   shadowCameraBottom: -40"
            position="-20 25 10">
        </a-entity>

        <!-- Ambient (Warm night atmosphere) -->
        <a-entity
            light="type: ambient;
                   color: #443333;
                   intensity: 0.6">
        </a-entity>

        <!-- Campfire/Torch Light (Warm orange glow) -->
        <a-entity
            light="type: point;
                   color: #FFaa00;
                   intensity: 1.2;
                   distance: 5"
            position="2 1 -1">
        </a-entity>

        <!-- =====================================================
             CAMERA & CONTROLS
             ===================================================== -->

        <a-entity id="rig" position="0 0 0">
            <a-camera
                id="camera"
                position="0 1.6 5"
                look-controls
                wasd-controls="acceleration: 20">
                <!-- GAZE CURSOR: Kijken om te selecteren (FUSE mode: 2 seconden kijken = klik) -->
                <a-cursor
                    id="gaze-cursor"
                    color="#FFD700"
                    opacity="0.8"
                    raycaster="objects: .clickable; far: 150"
                    fuse="true"
                    fuse-timeout="2000"
                    animation__fusing="property: scale; startEvents: fusing; dur: 2000; from: 1 1 1; to: 0.2 0.2 0.2; easing: easeInQuad"
                    animation__click="property: scale; startEvents: click; dur: 150; from: 0.2 0.2 0.2; to: 1 1 1; easing: easeOutQuad">
                </a-cursor>

            </a-camera>

            <!-- LEFT HAND (NATIVE HAND TRACKING - NO CONTROLLERS) -->
            <a-entity
                id="left-hand"
                hand-tracking-controls="hand: left"
                raycaster="objects: .clickable; far: 20; showLine: false"
                cursor="rayOrigin: entity"
                position="-0.3 1.4 -0.4">
                <!-- Visual debug sphere to see hand position -->
                <a-sphere radius="0.05" color="#FFD700" opacity="0.7" transparent="true"></a-sphere>
                <!-- MANUAL LASER LINE (cylinder) -->
                <a-cylinder
                    id="left-laser"
                    radius="0.005"
                    height="20"
                    color="#FFD700"
                    opacity="0.8"
                    position="0 0 -10"
                    rotation="90 0 0">
                </a-cylinder>
                <!-- Shield voor Level 3 (volgt hand positie exact) -->
                <a-entity
                    id="shield"
                    visible="false"
                    geometry="primitive: cylinder; radius: 0.5; height: 0.05"
                    material="color: #4169E1; metalness: 0.8; roughness: 0.2; emissive: #1E90FF; emissiveIntensity: 0.5; opacity: 0.9; transparent: true"
                    rotation="90 0 0"
                    shadow="cast: true">
                </a-entity>
            </a-entity>

            <!-- RIGHT HAND (NATIVE HAND TRACKING - NO CONTROLLERS) -->
            <a-entity
                id="right-hand"
                hand-tracking-controls="hand: right"
                raycaster="objects: .clickable; far: 20; showLine: false"
                cursor="rayOrigin: entity">
                <!-- Visual debug sphere to see hand position -->
                <a-sphere radius="0.05" color="#FFD700" opacity="0.7" transparent="true"></a-sphere>
                <!-- MANUAL LASER LINE (cylinder) -->
                <a-cylinder
                    id="right-laser"
                    radius="0.005"
                    height="20"
                    color="#FFD700"
                    opacity="0.8"
                    position="0 0 -10"
                    rotation="90 0 0">
                </a-cylinder>
            </a-entity>
        </a-entity>

        <!-- =====================================================
             GAME MANAGER
             ===================================================== -->

        <a-entity id="game-manager" final-game-manager grazing-animals nature-populator hand-shield-sync></a-entity>

    </a-scene>

    <script>
        console.log('üéÆ Script loading...');

        // =====================================================
        // 3D STORY OVERLAY SYSTEM (VR Compatible)
        // =====================================================

        // =====================================================
        // ENHANCED AUDIO ENGINE (with Wind, Buzz, Splat, Poof)
        // =====================================================
        class EnhancedAudioEngine {
            constructor() {
                this.context = new (window.AudioContext || window.webkitAudioContext)();
                this.windNoise = null;
                console.log('üîä Audio engine initialized');
            }

            playSuccess() {
                const melody = [523.25, 659.25, 783.99, 1046.50];
                this.playMelody(melody, 180);
            }

            playVictory() {
                const melody = [523.25, 587.33, 659.25, 783.99, 880.00, 1046.50, 1174.66, 1318.51];
                this.playMelody(melody, 220);
            }

            playMagicalChime() {
                // Grand finale arpeggio
                const melody = [523.25, 659.25, 783.99, 1046.50, 1318.51, 1568.00];
                this.playMelody(melody, 150);
            }

            playDamage() { this.playTone('sawtooth', 120, 0.35, 0.5); }
            playDrumBeat() { this.playTone('sawtooth', 50, 0.3, 0.18); }

            playPoof() {
                // Soft "poof" sound for wrong globe disappearing
                const noise = this.context.createBufferSource();
                const buffer = this.context.createBuffer(1, this.context.sampleRate * 0.3, this.context.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < data.length; i++) {
                    data[i] = Math.random() * 2 - 1;
                }
                noise.buffer = buffer;

                const filter = this.context.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = 200;

                const gain = this.context.createGain();
                gain.gain.setValueAtTime(0.3, this.context.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.3);

                noise.connect(filter);
                filter.connect(gain);
                gain.connect(this.context.destination);
                noise.start();
            }

            playSplat() {
                // Fly splat sound
                this.playTone('sine', 80, 0.4, 0.1);
            }

            playSquish() {
                // Rhino touch sound
                this.playTone('triangle', 150, 0.5, 0.2);
            }

            playHeartbeat() {
                // Heart pulse
                this.playTone('sine', 60, 0.6, 0.15);
            }

            startWind() {
                // Background wind loop from audio file
                if (this.windAudio) return;
                this.windAudio = document.getElementById('wind-loop');
                if (this.windAudio) {
                    this.windAudio.volume = 0.4;
                    this.windAudio.loop = true;
                    this.windAudio.play().catch(e => console.log('Wind audio play failed:', e));
                    console.log('üí® Wind loop started');
                }
            }

            stopWind() {
                if (this.windAudio) {
                    this.windAudio.pause();
                    this.windAudio.currentTime = 0;
                }
            }

            startInsects() {
                // Level 2 insects loop
                if (this.insectsAudio) return;
                this.insectsAudio = document.getElementById('insects-loop');
                if (this.insectsAudio) {
                    this.insectsAudio.volume = 0.5;
                    this.insectsAudio.loop = true;
                    this.insectsAudio.play().catch(e => console.log('Insects audio play failed:', e));
                    console.log('ü™∞ Insects loop started');
                }
            }

            stopInsects() {
                if (this.insectsAudio) {
                    this.insectsAudio.pause();
                    this.insectsAudio.currentTime = 0;
                }
            }

            playFart() {
                // One-shot fart when hand enters rhino
                const fart = document.getElementById('fart-sound');
                if (fart) {
                    fart.currentTime = 0;
                    fart.volume = 0.7;
                    fart.play().catch(e => console.log('Fart audio play failed:', e));
                    console.log('üí® Fart sound played');
                }
            }

            startSquishyLoop() {
                // Squishy loop while hand is inside rhino
                if (this.squishyAudio) return;
                this.squishyAudio = document.getElementById('squishy-loop');
                if (this.squishyAudio) {
                    this.squishyAudio.volume = 0.6;
                    this.squishyAudio.loop = true;
                    this.squishyAudio.play().catch(e => console.log('Squishy audio play failed:', e));
                    console.log('üí¶ Squishy loop started');
                }
            }

            stopSquishyLoop() {
                if (this.squishyAudio) {
                    this.squishyAudio.pause();
                    this.squishyAudio.currentTime = 0;
                }
            }

            playBuzz() {
                // Fly buzzing
                const osc = this.context.createOscillator();
                osc.type = 'sawtooth';
                osc.frequency.value = 220 + Math.random() * 100;

                const gain = this.context.createGain();
                gain.gain.setValueAtTime(0.15, this.context.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + 0.3);

                osc.connect(gain);
                gain.connect(this.context.destination);
                osc.start();
                osc.stop(this.context.currentTime + 0.3);
            }

            playTone(type, freq, gain, duration) {
                const osc = this.context.createOscillator();
                const gainNode = this.context.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                gainNode.gain.setValueAtTime(gain, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + duration);
                osc.connect(gainNode);
                gainNode.connect(this.context.destination);
                osc.start();
                osc.stop(this.context.currentTime + duration);
            }

            playMelody(notes, interval) {
                notes.forEach((freq, i) => {
                    setTimeout(() => this.playTone('sine', freq, 0.3, 0.25), i * interval);
                });
            }
        }

        const audioEngine = new EnhancedAudioEngine();

        // =====================================================
        // PHYSICS SYSTEM
        // =====================================================
        class PhysicsSystem {
            applyGravity(entity, deltaTime) {
                if (!entity.userData || !entity.userData.velocity) return;

                const vel = entity.userData.velocity;
                vel.y += -9.8 * deltaTime;

                const pos = entity.object3D.position;
                pos.x += vel.x * deltaTime;
                pos.y += vel.y * deltaTime;
                pos.z += vel.z * deltaTime;

                return pos.y <= 0;
            }
        }

        const physics = new PhysicsSystem();

        // =====================================================
        // DUST PARTICLE SYSTEM
        // =====================================================
        AFRAME.registerComponent('dust-system', {
            init: function() {
                console.log('üí® Spawning floating dust particles...');
                this.spawnDust();
            },

            spawnDust: function() {
                for (let i = 0; i < 30; i++) {
                    const dust = document.createElement('a-sphere');
                    dust.setAttribute('radius', 0.02 + Math.random() * 0.03);
                    dust.setAttribute('color', '#D2B48C');
                    dust.setAttribute('opacity', 0.3 + Math.random() * 0.2);
                    dust.setAttribute('material', 'transparent: true');

                    const x = (Math.random() - 0.5) * 40;
                    const y = Math.random() * 3 + 0.5;
                    const z = (Math.random() - 0.5) * 40;

                    dust.setAttribute('position', `${x} ${y} ${z}`);

                    dust.setAttribute('animation', {
                        property: 'position',
                        to: `${x + (Math.random() - 0.5) * 10} ${y + Math.random() * 2} ${z + (Math.random() - 0.5) * 10}`,
                        dur: 15000 + Math.random() * 10000,
                        easing: 'linear',
                        loop: true,
                        dir: 'alternate'
                    });

                    this.el.appendChild(dust);
                }
            }
        });

        // =====================================================
        // HAND TRACKING SHIELD SYNC
        // =====================================================
        AFRAME.registerComponent('hand-shield-sync', {
            init: function() {
                this.shield = document.getElementById('shield');
                this.leftHand = document.getElementById('left-hand');
                console.log('ü§ö Hand-shield sync initialized');
            },

            tick: function() {
                if (this.leftHand && this.shield && this.shield.getAttribute('visible')) {
                    const handPos = this.leftHand.object3D.position;
                    const handRot = this.leftHand.object3D.rotation;
                    this.shield.object3D.position.copy(handPos);
                    this.shield.object3D.rotation.copy(handRot);
                }
            }
        });

        // =====================================================
        // PROCEDURAL WAVY TERRAIN
        // =====================================================
        AFRAME.registerComponent('terrain-generator', {
            init: function() {
                console.log('üèúÔ∏è Generating wavy terrain...');
                this.el.addEventListener('loaded', () => this.generateWaves());
            },

            generateWaves: function() {
                const mesh = this.el.getObject3D('mesh');
                if (!mesh) return;

                const geometry = mesh.geometry;
                const vertices = geometry.attributes.position;

                for (let i = 0; i < vertices.count; i++) {
                    const x = vertices.getX(i);
                    const y = vertices.getY(i);
                    const z = Math.sin(x / 5) * Math.cos(y / 5) * 1.5;
                    vertices.setZ(i, z);
                }

                vertices.needsUpdate = true;
                geometry.computeVertexNormals();
                console.log('‚úì Wavy terrain generated');
            }
        });

        // =====================================================
        // GRAZING ANIMALS
        // =====================================================
        AFRAME.registerComponent('grazing-animals', {
            init: function() {
                console.log('ü¶å Spawning ANIMATED grazing animals...');
                setTimeout(() => {
                    this.spawnAnimals();
                    this.spawnRunningGiraffe();
                }, 2000);
            },

            spawnAnimals: function() {
                const animalTypes = ['deer', 'stag', 'bull', 'horse', 'fox'];
                const availableAnimals = animalTypes.filter(type =>
                    !!document.getElementById(`${type}-asset`)
                );

                if (availableAnimals.length === 0) return;

                for (let i = 0; i < 12; i++) {
                    const x = -30 + Math.random() * 60;
                    const z = -30 + Math.random() * 20;
                    const animalType = availableAnimals[Math.floor(Math.random() * availableAnimals.length)];

                    const animal = document.createElement('a-entity');
                    animal.setAttribute('gltf-model', `#${animalType}-asset`);
                    animal.setAttribute('position', `${x} 0 ${z}`);
                    animal.setAttribute('rotation', `0 ${Math.random() * 360} 0`);
                    animal.setAttribute('scale', '0.2 0.2 0.2');
                    animal.setAttribute('animation-mixer', 'clip: *; loop: repeat');
                    animal.setAttribute('shadow', 'cast: true; receive: true');
                    this.el.sceneEl.appendChild(animal);
                }
            },

            spawnRunningGiraffe: function() {
                if (!document.getElementById('giraffe-asset')) return;

                const giraffe = document.createElement('a-entity');
                giraffe.setAttribute('gltf-model', '#giraffe-asset');

                const startX = -60, startZ = -50;
                const endX = 60, endZ = 20;

                giraffe.setAttribute('position', `${startX} 0 ${startZ}`);
                giraffe.setAttribute('scale', '0.3 0.3 0.3');

                const angle = Math.atan2(endZ - startZ, endX - startX);
                const rotationY = THREE.MathUtils.radToDeg(angle) - 90;
                giraffe.setAttribute('rotation', `0 ${rotationY} 0`);

                giraffe.setAttribute('animation-mixer', 'clip: *; loop: repeat');
                giraffe.setAttribute('animation', {
                    property: 'position',
                    to: `${endX} 0 ${endZ}`,
                    dur: 8000,
                    easing: 'linear',
                    loop: false
                });

                this.el.sceneEl.appendChild(giraffe);

                setInterval(() => {
                    giraffe.setAttribute('position', `${startX} 0 ${startZ}`);
                    giraffe.setAttribute('animation', {
                        property: 'position',
                        to: `${endX} 0 ${endZ}`,
                        dur: 8000,
                        easing: 'linear',
                        loop: false
                    });
                }, 30000);
            }
        });

        // =====================================================
        // NATURE PACK POPULATOR
        // =====================================================
        AFRAME.registerComponent('nature-populator', {
            init: function() {
                console.log('üåø Populating dunes...');
                setTimeout(() => this.populateDunes(), 3000);
            },

            populateDunes: function() {
                const hasTree = !!document.getElementById('tree-asset');
                for (let i = 0; i < 5; i++) {
                    if (hasTree) {
                        const tree = document.createElement('a-entity');
                        tree.setAttribute('gltf-model', '#tree-asset');
                        tree.setAttribute('position', `${this.randomX()} -0.5 ${this.randomZ()}`);
                        tree.setAttribute('scale', `${0.8 + Math.random() * 0.4} ${0.8 + Math.random() * 0.4} ${0.8 + Math.random() * 0.4}`);
                        tree.setAttribute('rotation', `0 ${Math.random() * 360} 0`);
                        tree.setAttribute('shadow', 'cast: true');
                        this.el.sceneEl.appendChild(tree);
                    }
                }
            },

            randomX: function() { return -40 + Math.random() * 80; },
            randomZ: function() { return -40 + Math.random() * 80; }
        });

        // =====================================================
        // GAME STATES
        // =====================================================
        const GAME_STATES = {
            INTRO: 'intro',
            LEVEL_1: 'level_1',      // Find Namibia
            LEVEL_2: 'level_2',      // Swat Flies
            LEVEL_3: 'level_3',      // Block Spears
            LEVEL_4: 'level_4',      // Rhino Heart
            VICTORY: 'victory'
        };

        // =====================================================
        // FINAL GAME MANAGER
        // =====================================================
        AFRAME.registerComponent('final-game-manager', {
            init: function() {
                console.log('üéÆ FINAL GAME MANAGER INITIALIZED');

                this.currentState = null;
                this.activeObjects = [];
                this.physicsObjects = [];

                this.camera = document.getElementById('camera');
                this.shield = document.getElementById('shield');
                this.leftHand = document.getElementById('left-hand');
                this.rightHand = document.getElementById('right-hand');

                // Asset checks
                this.hasRhino = !!document.getElementById('rhino-asset');
                this.hasHunter = !!document.getElementById('hunter-asset');
                this.hasFly = !!document.getElementById('fly-model');
                this.hasHeart = !!document.getElementById('heart-model');

                console.log('ü¶è Assets loaded:', {
                    rhino: this.hasRhino,
                    hunter: this.hasHunter,
                    fly: this.hasFly,
                    heart: this.hasHeart
                });

                // Level 1 (Globes)
                this.level1Target = 'NAMIBI√ã';

                // Level 2 (Flies)
                this.level2FliesKilled = 0;
                this.level2Target = 10;

                // Level 3 (Spears)
                this.level3Score = 0;
                this.level3Target = 15;

                // Level 4 (Rhino)
                this.rhinoTouched = false;
                this.heartTouched = false;

                // Start wind ambient
                audioEngine.startWind();

                // Expose for skip button
                window.gameManager = this;

                // Start game after assets load
                this.el.sceneEl.addEventListener('loaded', () => {
                    console.log('‚úì Scene loaded, starting game...');
                    setTimeout(() => this.startIntro(), 2000);
                });
            },

            tick: function(time, deltaTime) {
                const dt = deltaTime / 1000;

                // Physics for spears
                this.physicsObjects.forEach(obj => {
                    if (physics.applyGravity(obj, dt)) {
                        if (obj.parentNode) obj.parentNode.removeChild(obj);
                    }
                });

                // Shield collision detection (Level 3)
                if (this.currentState === GAME_STATES.LEVEL_3) {
                    this.checkShieldCollisions();
                }

                // Hand collision detection (Level 2 - Flies)
                if (this.currentState === GAME_STATES.LEVEL_2) {
                    this.checkHandFlyCollisions();
                }

                // Hand collision detection (Level 4 - Rhino)
                if (this.currentState === GAME_STATES.LEVEL_4 && !this.rhinoTouched) {
                    this.checkHandRhinoCollision();
                }
            },

            updateHUD: function(title, objective, progress) {
                document.getElementById('level-title').textContent = title;
                document.getElementById('objective').textContent = objective;
                document.getElementById('progress').textContent = progress;
            },

            showBriefing: function(title, text, instructions, callback) {
                // EXECUTE CALLBACK IMMEDIATELY (don't wait for dismiss!)
                console.log('‚ö° Executing callback immediately');
                if (callback) callback();

                // Create 3D briefing panel in VR
                const briefing = document.createElement('a-entity');
                briefing.setAttribute('id', 'briefing-panel');
                briefing.setAttribute('position', '0 1.6 -2.5'); // Further away for better view
                briefing.setAttribute('look-at', '[camera]'); // ALWAYS face camera!

                // Black background (BIGGER & TALLER for instructions)
                const bg = document.createElement('a-plane');
                bg.setAttribute('width', '3.5');
                bg.setAttribute('height', '2.8');
                bg.setAttribute('color', '#000000');
                bg.setAttribute('opacity', '0.95');
                briefing.appendChild(bg);

                // Title
                const titleText = document.createElement('a-text');
                titleText.setAttribute('value', title);
                titleText.setAttribute('align', 'center');
                titleText.setAttribute('color', '#00FF00');
                titleText.setAttribute('width', '3.2');
                titleText.setAttribute('position', '0 1 0.01');
                briefing.appendChild(titleText);

                // Message
                const msgText = document.createElement('a-text');
                msgText.setAttribute('value', text);
                msgText.setAttribute('align', 'center');
                msgText.setAttribute('color', '#FFFFFF');
                msgText.setAttribute('width', '3');
                msgText.setAttribute('position', '0 0.4 0.01');
                msgText.setAttribute('wrap-count', '40');
                briefing.appendChild(msgText);

                // Instructions (HOW TO INTERACT)
                const instructText = document.createElement('a-text');
                instructText.setAttribute('value', instructions);
                instructText.setAttribute('align', 'center');
                instructText.setAttribute('color', '#FFD700');
                instructText.setAttribute('width', '3');
                instructText.setAttribute('position', '0 -0.2 0.01');
                instructText.setAttribute('wrap-count', '40');
                briefing.appendChild(instructText);

                // Continue button (BIGGER clickable plane)
                const button = document.createElement('a-plane');
                button.setAttribute('width', '2.5'); // Even bigger
                button.setAttribute('height', '0.6');
                button.setAttribute('color', '#00FF00');
                button.setAttribute('position', '0 -0.95 0.01');
                button.classList.add('clickable');

                const buttonText = document.createElement('a-text');
                buttonText.setAttribute('value', 'DOORGAAN\n(Knijp duim+wijsvinger)');
                buttonText.setAttribute('align', 'center');
                buttonText.setAttribute('color', '#000000');
                buttonText.setAttribute('width', '4');
                buttonText.setAttribute('position', '0 0 0.01');
                button.appendChild(buttonText);

                // Click handler
                const dismiss = () => {
                    console.log('‚úì Briefing dismissed by user');
                    if (briefing.parentNode) briefing.parentNode.removeChild(briefing);
                };

                button.addEventListener('click', dismiss);

                // NO AUTO-DISMISS - only manual click!
                console.log('‚è±Ô∏è Briefing will stay until user clicks DOORGAAN');

                briefing.appendChild(button);
                this.el.sceneEl.appendChild(briefing);
            },

            clearAllObjects: function() {
                this.activeObjects.forEach(obj => {
                    if (obj.parentNode) obj.parentNode.removeChild(obj);
                });
                this.activeObjects = [];
                this.physicsObjects = [];
            },

            skipLevel: function() {
                console.log('‚è≠Ô∏è Skipping level:', this.currentState);
                switch(this.currentState) {
                    case GAME_STATES.INTRO: this.startLevel1(); break;
                    case GAME_STATES.LEVEL_1: this.completeLevel1(); break;
                    case GAME_STATES.LEVEL_2: this.completeLevel2(); break;
                    case GAME_STATES.LEVEL_3: this.completeLevel3(); break;
                    case GAME_STATES.LEVEL_4: this.completeLevel4(); break;
                    case GAME_STATES.VICTORY: location.reload(); break;
                }
            },

            // =====================================================
            // INTRO
            // =====================================================
            startIntro: function() {
                console.log('üé¨ Starting intro...');
                this.currentState = GAME_STATES.INTRO;
                this.updateHUD('üåç VIBEKE\'S GROTE EXPEDITIE', 'Klaar voor vertrek...', '');
                setTimeout(() => this.startLevel1(), 2000);
            },

            // =====================================================
            // LEVEL 1: DE BESTEMMING (Find Namibia)
            // =====================================================
            startLevel1: function() {
                console.log('üåç Starting Level 1...');
                this.currentState = GAME_STATES.LEVEL_1;
                this.clearAllObjects();
                this.updateHUD('üåç NIVEAU 1: DE BESTEMMING', 'Zoek Namibi√´ op de wereldkaart!', '');

                // Show briefing in VR
                this.showBriefing(
                    'NIVEAU 1: DE BESTEMMING',
                    'Lieve Vibeke,\n\nWe gaan met de HELE familie op reis!\nMaar waarheen?\n\nZoek de juiste bestemming...',
                    'HOE TE SPELEN:\n- Wijs met je hand naar een bol\n- Knijp duim+wijsvinger (pinch) om te klikken\n- Zoek NAMIBI√ã!',
                    () => this.spawnGlobes()
                );
            },

            spawnGlobes: function() {
                const destinations = [
                    { name: 'Xian', isTarget: false },
                    { name: 'Texel', isTarget: false },
                    { name: 'Jeruzalem', isTarget: false },
                    { name: 'Denemarken', isTarget: false },
                    { name: 'Hongarije', isTarget: false },
                    { name: 'NAMIBI√ã', isTarget: true },
                ];

                destinations.forEach((dest, i) => {
                    setTimeout(() => {
                        if (this.currentState === GAME_STATES.LEVEL_1) {
                            this.spawnGlobe(dest, (Math.PI * 2 / destinations.length) * i);
                        }
                    }, i * 600);
                });
            },

            spawnGlobe: function(destination, angle) {
                const globe = document.createElement('a-entity');

                const radius = 5;
                const height = 1.6;
                const x = Math.cos(angle) * radius;
                const z = Math.sin(angle) * radius;

                globe.setAttribute('position', `${x} ${height} ${z}`);
                globe.classList.add('globe', 'clickable');
                globe.setAttribute('data-name', destination.name);
                globe.setAttribute('data-is-target', destination.isTarget);

                // Visual sphere (0.5 radius)
                const sphere = document.createElement('a-sphere');
                sphere.setAttribute('radius', '0.5');
                sphere.setAttribute('color', destination.isTarget ? '#FFD700' : '#4169E1');
                sphere.setAttribute('metalness', '0.5');
                sphere.setAttribute('roughness', '0.4');
                sphere.setAttribute('shadow', 'cast: true');
                globe.appendChild(sphere);

                // LARGER INVISIBLE HITBOX for easier clicking with raycaster!
                const hitbox = document.createElement('a-sphere');
                hitbox.setAttribute('radius', '1.5'); // 3x bigger!
                hitbox.setAttribute('opacity', '0');
                hitbox.setAttribute('transparent', 'true');
                hitbox.classList.add('clickable'); // Also clickable
                globe.appendChild(hitbox);

                const label = document.createElement('a-text');
                label.setAttribute('value', destination.name);
                label.setAttribute('align', 'center');
                label.setAttribute('color', destination.isTarget ? '#FF6347' : '#FFFFFF');
                label.setAttribute('width', '4');
                label.setAttribute('position', '0 0.9 0');
                label.setAttribute('look-at', '[camera]');
                globe.appendChild(label);

                globe.setAttribute('animation', {
                    property: 'rotation',
                    to: '0 360 0',
                    dur: 12000,
                    loop: true,
                    easing: 'linear'
                });

                globe.addEventListener('click', () => this.handleGlobeClick(globe));

                this.el.sceneEl.appendChild(globe);
                this.activeObjects.push(globe);
            },

            handleGlobeClick: function(globe) {
                const isTarget = globe.getAttribute('data-is-target') === 'true';
                const name = globe.getAttribute('data-name');

                console.log('üåç Globe clicked:', name, 'isTarget:', isTarget);

                if (isTarget) {
                    console.log('‚úì Found Namibia!');
                    audioEngine.playSuccess();
                    this.updateHUD('‚úàÔ∏è NIVEAU 1', `‚úì GEVONDEN: ${name}!`, '');
                    this.createExplosion(globe.object3D.position, '#FFD700', 60);

                    // Remove globe immediately
                    globe.parentNode.removeChild(globe);
                    this.activeObjects = this.activeObjects.filter(o => o !== globe);

                    setTimeout(() => this.completeLevel1(), 2000);
                } else {
                    // Wrong globe - POOF!
                    console.log('‚úó Wrong destination:', name, '- removing globe');
                    audioEngine.playPoof();
                    this.createExplosion(globe.object3D.position, '#888888', 20);

                    // Remove globe immediately
                    globe.parentNode.removeChild(globe);
                    this.activeObjects = this.activeObjects.filter(o => o !== globe);
                }
            },

            completeLevel1: function() {
                console.log('‚úì Level 1 complete!');
                this.clearAllObjects();
                audioEngine.playSuccess();
                this.updateHUD('‚úì NIVEAU 1 VOLTOOID!', 'JA! We gaan naar NAMIBI√ã!', '');
                setTimeout(() => this.startLevel2(), 2500);
            },

            // =====================================================
            // LEVEL 2: DE VOORBEREIDING (Swat Flies)
            // =====================================================
            startLevel2: function() {
                console.log('ü™∞ Starting Level 2...');
                this.currentState = GAME_STATES.LEVEL_2;
                this.clearAllObjects();
                this.level2FliesKilled = 0;
                this.level2TotalFlies = 18; // Total flies to spawn
                audioEngine.startInsects(); // Start insects loop
                this.updateHUD('ü™∞ NIVEAU 2: DE VOORBEREIDING', 'Mep de vliegen weg!', `${this.level2FliesKilled} / ${this.level2Target}`);

                this.showBriefing(
                    'NIVEAU 2: DE VOORBEREIDING',
                    'Pas op! In de rimboe zoemen\nveel beestjes...\n\nEven oefenen!\nMep 10 vliegen weg\nmet je HANDEN!',
                    'HOE TE SPELEN:\n- Beweeg je handen naar de vliegen\n- Raak ze aan om te meppen\n- Geen pinch nodig, gewoon AANRAKEN!',
                    () => this.spawnFlies()
                );
            },

            spawnFlies: function() {
                // Spawn 18 flies total, but only need to kill 10
                for (let i = 0; i < this.level2TotalFlies; i++) {
                    setTimeout(() => {
                        if (this.currentState === GAME_STATES.LEVEL_2) {
                            this.spawnFly();
                        }
                    }, i * 500); // Faster spawn rate
                }
            },

            spawnFly: function() {
                const fly = document.createElement('a-entity');

                if (this.hasFly) {
                    // Use actual fly model
                    fly.setAttribute('gltf-model', '#fly-model');
                    fly.setAttribute('scale', '0.05 0.05 0.05');
                    fly.setAttribute('rotation', `0 ${Math.random() * 360} ${Math.random() * 360}`);
                } else {
                    // Fallback: black sphere
                    const sphere = document.createElement('a-sphere');
                    sphere.setAttribute('radius', '0.08');
                    sphere.setAttribute('color', '#000000');
                    sphere.setAttribute('metalness', '0.8');
                    fly.appendChild(sphere);
                }

                // Add LARGE INVISIBLE HITBOX (basketball size) for easier swatting
                const hitbox = document.createElement('a-sphere');
                hitbox.setAttribute('radius', '0.4'); // Big hitbox!
                hitbox.setAttribute('opacity', '0');
                hitbox.setAttribute('transparent', 'true');
                hitbox.classList.add('fly-hitbox');
                fly.appendChild(hitbox);

                fly.classList.add('fly', 'clickable');

                // Random position ALL AROUND (360¬∞) at varying heights (0.5m to 2.0m)
                const angle = Math.random() * Math.PI * 2; // Full 360 degrees
                const distance = 0.8 + Math.random() * 0.7; // 0.8 to 1.5 meters away
                const x = Math.cos(angle) * distance;
                const y = 0.5 + Math.random() * 1.5; // Height: 0.5m to 2.0m
                const z = Math.sin(angle) * distance;

                fly.setAttribute('position', `${x} ${y} ${z}`);

                // FASTER, more erratic flying animation
                const moveRange = 0.8; // Bigger movement range
                fly.setAttribute('animation__buzz', {
                    property: 'position',
                    to: `${x + (Math.random() - 0.5) * moveRange} ${y + (Math.random() - 0.5) * moveRange} ${z + (Math.random() - 0.5) * moveRange}`,
                    dur: 300 + Math.random() * 400, // Faster!
                    loop: true,
                    dir: 'alternate',
                    easing: 'linear'
                });

                fly.addEventListener('click', () => this.handleFlySplat(fly));

                // Play buzz sound
                audioEngine.playBuzz();

                this.el.sceneEl.appendChild(fly);
                this.activeObjects.push(fly);
            },

            handleFlySplat: function(fly) {
                console.log('üí• Fly splatted!');
                audioEngine.playSplat();
                this.level2FliesKilled++;
                this.updateHUD('ü™∞ NIVEAU 2: DE VOORBEREIDING', 'Mep die vliegen!', `${this.level2FliesKilled} / ${this.level2Target}`);

                if (fly.parentNode) {
                    fly.parentNode.removeChild(fly);
                    this.activeObjects = this.activeObjects.filter(o => o !== fly);
                }

                if (this.level2FliesKilled >= this.level2Target) {
                    setTimeout(() => this.completeLevel2(), 1000);
                }
            },

            checkHandFlyCollisions: function() {
                if (!this.leftHand || !this.rightHand) return;

                const leftPos = new THREE.Vector3();
                const rightPos = new THREE.Vector3();
                this.leftHand.object3D.getWorldPosition(leftPos);
                this.rightHand.object3D.getWorldPosition(rightPos);

                const fliesHit = [];
                this.activeObjects.forEach(obj => {
                    if (obj.classList && obj.classList.contains('fly')) {
                        const flyPos = new THREE.Vector3();
                        obj.object3D.getWorldPosition(flyPos);

                        const distLeft = leftPos.distanceTo(flyPos);
                        const distRight = rightPos.distanceTo(flyPos);

                        // VEEL GROTER: 0.8m radius for easy swatting!
                        if (distLeft < 0.8 || distRight < 0.8) {
                            fliesHit.push(obj);
                        }
                    }
                });

                // Handle all hits (prevent multiple removes)
                fliesHit.forEach(fly => this.handleFlySplat(fly));
            },

            completeLevel2: function() {
                console.log('‚úì Level 2 complete!');
                this.clearAllObjects();
                audioEngine.stopInsects(); // Stop insects loop
                audioEngine.playSuccess();
                this.updateHUD('‚úì NIVEAU 2 VOLTOOID!', 'Perfect! Klaar voor het avontuur!', '');
                setTimeout(() => this.startLevel3(), 2500);
            },

            // =====================================================
            // LEVEL 3: DE BESCHERMER (Block Spears)
            // =====================================================
            startLevel3: function() {
                console.log('üõ°Ô∏è Starting Level 3...');
                this.currentState = GAME_STATES.LEVEL_3;
                this.clearAllObjects();
                this.level3Score = 0;

                this.showBriefing(
                    'NIVEAU 3: DE BESCHERMER',
                    'Het wordt een wild avontuur!\n\nJij moet de familie beschermen.\n\nBlokkeer 15 speren met\nje LINKERHAND!',
                    'HOE TE SPELEN:\n- Beweeg je LINKERHAND voor de speren\n- Een blauw schild verschijnt op je hand\n- Blokkeer de speren voordat ze je raken!',
                    () => this.setupLevel3()
                );
            },

            setupLevel3: function() {
                this.updateHUD('üõ°Ô∏è NIVEAU 3: DE BESCHERMER', 'Blokkeer speren met je LINKERHAND!', `${this.level3Score} / ${this.level3Target}`);

                if (this.shield) {
                    this.shield.setAttribute('visible', 'true');
                }

                this.spawnAmbushBushes();

                let hunterIndex = 0;
                for (let bushIndex = 0; bushIndex < 3; bushIndex++) {
                    for (let row = 0; row < 2; row++) {
                        const colsInRow = row === 0 ? 2 : 3;
                        for (let col = 0; col < colsInRow; col++) {
                            setTimeout(() => {
                                if (this.currentState === GAME_STATES.LEVEL_3) {
                                    this.spawnHunterWithSpear(bushIndex, row, col);
                                }
                            }, hunterIndex * 500);
                            hunterIndex++;
                        }
                    }
                }
            },

            spawnAmbushBushes: function() {
                const bushRadius = 15;
                for (let i = 0; i < 3; i++) {
                    const angle = (Math.PI * 2 / 3) * i;
                    const x = Math.cos(angle) * bushRadius;
                    const z = Math.sin(angle) * bushRadius;

                    const bush = document.createElement('a-entity');
                    bush.setAttribute('position', `${x} 0 ${z}`);

                    const foliage1 = document.createElement('a-sphere');
                    foliage1.setAttribute('radius', '2');
                    foliage1.setAttribute('position', '0 1.5 0');
                    foliage1.setAttribute('color', '#2d5016');
                    foliage1.setAttribute('roughness', '1');
                    foliage1.setAttribute('shadow', 'cast: true; receive: true');
                    bush.appendChild(foliage1);

                    const trunk = document.createElement('a-cylinder');
                    trunk.setAttribute('radius', '0.3');
                    trunk.setAttribute('height', '2');
                    trunk.setAttribute('position', '0 1 0');
                    trunk.setAttribute('color', '#4a3c28');
                    bush.appendChild(trunk);

                    this.el.sceneEl.appendChild(bush);
                    this.activeObjects.push(bush);
                }
            },

            spawnHunterWithSpear: function(bushIndex, row, col) {
                const bushRadius = 15;
                const bushAngle = (Math.PI * 2 / 3) * bushIndex;
                const bushX = Math.cos(bushAngle) * bushRadius;
                const bushZ = Math.sin(bushAngle) * bushRadius;

                const rightX = -Math.sin(bushAngle);
                const rightZ = Math.cos(bushAngle);

                const spacing = 1.5;
                const x = bushX + rightX * 1 + (col - 1) * spacing * rightX;
                const z = bushZ + rightZ * 1 + (col - 1) * spacing * rightZ - (row * spacing);
                const height = 0;

                const angleToCamera = Math.atan2(-x, -z);
                const rotationY = THREE.MathUtils.radToDeg(angleToCamera);

                if (this.hasHunter) {
                    const hunter = document.createElement('a-entity');
                    hunter.setAttribute('gltf-model', '#hunter-asset');
                    hunter.setAttribute('position', `${x} ${height} ${z}`);
                    hunter.setAttribute('scale', '0.1625 0.1625 0.1625');  // 65% of 0.25
                    hunter.setAttribute('rotation', `0 ${rotationY} 0`);
                    hunter.setAttribute('shadow', 'cast: true');

                    const targetDistance = 5;
                    const walkDuration = 30000;
                    const directionToCamera = Math.sqrt(x*x + z*z);
                    const walkRatio = targetDistance / directionToCamera;
                    const targetX = x * walkRatio;
                    const targetZ = z * walkRatio;

                    hunter.setAttribute('animation', {
                        property: 'position',
                        to: `${targetX} ${height} ${targetZ}`,
                        dur: walkDuration,
                        easing: 'linear'
                    });

                    this.el.sceneEl.appendChild(hunter);
                    this.activeObjects.push(hunter);
                }

                const spearInterval = setInterval(() => {
                    if (this.currentState === GAME_STATES.LEVEL_3) {
                        this.launchSpear(x, height + 1.5, z);
                    } else {
                        clearInterval(spearInterval);
                    }
                }, 3000 + Math.random() * 2000);
            },

            launchSpear: function(startX, startY, startZ) {
                const spear = document.createElement('a-entity');
                spear.setAttribute('position', `${startX} ${startY} ${startZ}`);
                spear.classList.add('spear');
                spear.setAttribute('shadow', 'cast: true');

                const shaft = document.createElement('a-cylinder');
                shaft.setAttribute('radius', '0.05');
                shaft.setAttribute('height', '2.5');
                shaft.setAttribute('color', '#8B4513');
                shaft.setAttribute('rotation', '0 0 90');
                shaft.setAttribute('metalness', '0.2');
                shaft.setAttribute('roughness', '0.8');
                spear.appendChild(shaft);

                const tip = document.createElement('a-cone');
                tip.setAttribute('radius-bottom', '0.12');
                tip.setAttribute('height', '0.4');
                tip.setAttribute('color', '#C0C0C0');
                tip.setAttribute('position', '1.25 0 0');
                tip.setAttribute('rotation', '0 0 -90');
                tip.setAttribute('metalness', '0.9');
                tip.setAttribute('roughness', '0.2');
                spear.appendChild(tip);

                spear.setAttribute('look-at', '[camera]');

                // Target CHEST HEIGHT (1.5m) not feet!
                const targetPos = new THREE.Vector3(0, 1.5, 0);
                const direction = new THREE.Vector3(
                    targetPos.x - startX,
                    targetPos.y - startY,
                    targetPos.z - startZ
                ).normalize();

                // FASTER velocity for straighter trajectory
                spear.userData = {
                    velocity: {
                        x: direction.x * 25, // Increased from 15
                        y: direction.y * 25, // Straighter flight
                        z: direction.z * 25
                    },
                    isSpear: true
                };

                this.el.sceneEl.appendChild(spear);
                this.activeObjects.push(spear);
                this.physicsObjects.push(spear);
            },

            checkShieldCollisions: function() {
                if (!this.shield || !this.shield.object3D) return;

                const shieldPos = new THREE.Vector3();
                this.shield.object3D.getWorldPosition(shieldPos);

                this.physicsObjects.forEach(obj => {
                    if (obj.userData && obj.userData.isSpear && obj.parentNode) {
                        const spearPos = obj.object3D.position;
                        const distance = shieldPos.distanceTo(spearPos);

                        if (distance < 0.6) {
                            audioEngine.playSuccess();
                            this.level3Score++;
                            this.updateHUD('üõ°Ô∏è NIVEAU 3: DE BESCHERMER', 'Perfect! Blijf blokkeren!', `${this.level3Score} / ${this.level3Target}`);

                            this.createExplosion(spearPos, '#FFD700', 30);
                            obj.parentNode.removeChild(obj);
                            this.physicsObjects = this.physicsObjects.filter(o => o !== obj);

                            if (this.level3Score >= this.level3Target) {
                                setTimeout(() => this.completeLevel3(), 1000);
                            }
                        }
                    }
                });
            },

            completeLevel3: function() {
                console.log('‚úì Level 3 complete!');
                if (this.shield) {
                    this.shield.setAttribute('visible', 'false');
                }
                this.clearAllObjects();
                audioEngine.playSuccess();
                this.updateHUD('‚úì NIVEAU 3 VOLTOOID!', 'Je bent een held!', '');
                setTimeout(() => this.startLevel4(), 2500);
            },

            // =====================================================
            // LEVEL 4: DE ONTMOETING (Rhino Heart)
            // =====================================================
            startLevel4: function() {
                console.log('ü¶è Starting Level 4...');
                this.currentState = GAME_STATES.LEVEL_4;
                this.clearAllObjects();
                this.rhinoTouched = false;
                this.heartTouched = false;
                this.updateHUD('ü¶è NIVEAU 4: DE ONTMOETING', 'Raak de neushoorn aan...', '');

                this.showBriefing(
                    'NIVEAU 4: DE ONTMOETING',
                    'Kijk! De Big Five!\n\nDeze neushoorn heeft\niets bijzonders voor je...\n\nSteek je hand erin\nom het hart te vinden!',
                    'HOE TE SPELEN:\n- Beweeg je hand NAAR de neushoorn\n- Steek je hand DOOR hem heen\n- Vind het hart in zijn buik!',
                    () => this.spawnRhino()
                );
            },

            spawnRhino: function() {
                const rhinoContainer = document.createElement('a-entity');
                rhinoContainer.setAttribute('id', 'rhino-boss');
                rhinoContainer.setAttribute('position', '0 0.5 -2.5'); // Further back and higher!
                rhinoContainer.setAttribute('shadow', 'cast: true; receive: true');

                // Flag to track if hand entered rhino
                this.handInsideRhino = false;

                if (this.hasRhino) {
                    const rhino = document.createElement('a-entity');
                    rhino.setAttribute('gltf-model', '#rhino-asset');
                    rhino.setAttribute('scale', '2 2 2');
                    rhino.setAttribute('rotation', '0 200 0');
                    rhino.classList.add('clickable', 'rhino-body');

                    rhino.setAttribute('animation__breath', {
                        property: 'scale',
                        from: '2 2 2',
                        to: '2.05 2.05 2.05',
                        dur: 3500,
                        loop: true,
                        dir: 'alternate',
                        easing: 'easeInOutSine'
                    });

                    rhino.addEventListener('click', () => this.handleRhinoTouch(rhino));

                    rhinoContainer.appendChild(rhino);
                } else {
                    const body = document.createElement('a-box');
                    body.setAttribute('width', '2');
                    body.setAttribute('height', '1.2');
                    body.setAttribute('depth', '1');
                    body.setAttribute('color', '#696969');
                    body.setAttribute('opacity', '0.6');
                    body.setAttribute('material', 'transparent: true; metalness: 0.3; roughness: 0.7');
                    body.setAttribute('rotation', '0 180 0');
                    body.classList.add('clickable', 'rhino-body');
                    body.addEventListener('click', () => this.handleRhinoTouch(body));
                    rhinoContainer.appendChild(body);
                }

                // Heart (hidden initially) - Using bottle.glb model - LOWER in belly, SMALLER
                const heart = document.createElement('a-entity');
                heart.setAttribute('id', 'rhino-heart');
                heart.setAttribute('position', '0 -0.3 0'); // Lower - in the belly
                heart.classList.add('clickable');

                if (this.hasHeart) {
                    // Use actual heart/bottle model - MUCH SMALLER
                    heart.setAttribute('gltf-model', '#heart-model');
                    heart.setAttribute('scale', '0.02 0.02 0.02'); // Tiny!
                    heart.setAttribute('rotation', '0 0 0');
                    heart.setAttribute('material', 'opacity: 0; transparent: true');
                } else {
                    // Fallback: red sphere - SMALLER
                    const sphere = document.createElement('a-sphere');
                    sphere.setAttribute('radius', '0.04'); // Small radius
                    sphere.setAttribute('color', '#DC143C');
                    sphere.setAttribute('material', 'emissive: #FF0000; emissiveIntensity: 1.5; metalness: 0.8; roughness: 0.2; opacity: 0; transparent: true');
                    heart.appendChild(sphere);
                }

                heart.setAttribute('animation__pulse', {
                    property: 'scale',
                    from: '0.02 0.02 0.02',
                    to: '0.025 0.025 0.025',
                    dur: 800,
                    loop: true,
                    dir: 'alternate',
                    easing: 'easeInOutSine'
                });

                heart.addEventListener('click', () => this.handleHeartTouch(heart));

                rhinoContainer.appendChild(heart);

                const label = document.createElement('a-text');
                label.setAttribute('value', 'Raak de neushoorn aan...');
                label.setAttribute('align', 'center');
                label.setAttribute('color', '#FFD700');
                label.setAttribute('width', '3');
                label.setAttribute('position', '0 1.8 0');
                label.setAttribute('look-at', '[camera]');
                label.setAttribute('id', 'rhino-label');
                rhinoContainer.appendChild(label);

                this.el.sceneEl.appendChild(rhinoContainer);
                this.activeObjects.push(rhinoContainer);
            },

            checkHandRhinoCollision: function() {
                if (!this.leftHand || !this.rightHand) return;

                const rhinoContainer = document.getElementById('rhino-boss');
                if (!rhinoContainer) return;

                const leftPos = new THREE.Vector3();
                const rightPos = new THREE.Vector3();
                this.leftHand.object3D.getWorldPosition(leftPos);
                this.rightHand.object3D.getWorldPosition(rightPos);

                const rhinoPos = rhinoContainer.object3D.position;
                const distLeft = leftPos.distanceTo(rhinoPos);
                const distRight = rightPos.distanceTo(rhinoPos);

                // Check if hand is inside rhino (within 1.5m radius)
                if ((distLeft < 1.5 || distRight < 1.5) && !this.handInsideRhino) {
                    this.handInsideRhino = true;
                    console.log('üëã Hand entered rhino!');

                    // Play FART sound once
                    audioEngine.playFart();

                    // Start SQUISHY loop
                    audioEngine.startSquishyLoop();

                    // Make rhino transparent
                    this.handleRhinoTouch(rhinoContainer);
                }
            },

            handleRhinoTouch: function(rhino) {
                if (this.rhinoTouched) return;
                this.rhinoTouched = true;

                console.log('ü¶è Rhino becoming transparent!');
                this.updateHUD('ü¶è NIVEAU 4: DE ONTMOETING', 'Zoek het hart...', '');

                // Make rhino transparent (X-ray)
                rhino.setAttribute('material', 'opacity: 0.3; transparent: true');

                // Reveal heart
                const heart = document.getElementById('rhino-heart');
                if (heart) {
                    heart.setAttribute('animation__reveal', {
                        property: 'material.opacity',
                        from: 0,
                        to: 1,
                        dur: 2000,
                        easing: 'easeInQuad'
                    });

                    // Start heartbeat sound loop
                    this.heartbeatInterval = setInterval(() => {
                        if (this.currentState === GAME_STATES.LEVEL_4 && !this.heartTouched) {
                            audioEngine.playHeartbeat();
                        } else {
                            clearInterval(this.heartbeatInterval);
                        }
                    }, 800);
                }

                // Update label
                const label = document.getElementById('rhino-label');
                if (label) {
                    label.setAttribute('value', 'Raak het hart aan!');
                }
            },

            handleHeartTouch: function(heart) {
                if (this.heartTouched) return;
                this.heartTouched = true;

                console.log('üíñ Heart touched!');
                audioEngine.stopSquishyLoop(); // Stop squishy loop
                audioEngine.playMagicalChime();
                this.updateHUD('üíñ NIVEAU 4 VOLTOOID!', 'Het hart van Afrika!', '');

                heart.setAttribute('animation__explode', {
                    property: 'scale',
                    to: '2 2 2',
                    dur: 1500,
                    easing: 'easeOutQuad'
                });

                heart.setAttribute('animation__fade', {
                    property: 'material.opacity',
                    to: 0,
                    dur: 1500,
                    easing: 'easeInQuad'
                });

                setTimeout(() => this.completeLevel4(), 2000);
            },

            completeLevel4: function() {
                console.log('‚úì Level 4 complete!');
                this.clearAllObjects();
                this.startVictory();
            },

            // =====================================================
            // VICTORY SEQUENCE
            // =====================================================
            startVictory: function() {
                console.log('üèÜ VICTORY!');
                this.currentState = GAME_STATES.VICTORY;
                audioEngine.playVictory();
                this.updateHUD('üèÜ MISSIE VOLTOOID!', 'Alle levels uitgespeeld!', '');

                for (let i = 0; i < 12; i++) {
                    setTimeout(() => {
                        const pos = new THREE.Vector3(
                            (Math.random() - 0.5) * 10,
                            2 + Math.random() * 5,
                            -4 - Math.random() * 4
                        );
                        this.createExplosion(pos, ['#FFD700', '#FF6347', '#00FF00', '#87CEEB', '#FF69B4', '#FFA500'][i % 6], 80);
                    }, i * 800);
                }

                setTimeout(() => this.showFinalReward(), 5000);
            },

            showFinalReward: function() {
                console.log('üéÅ Showing final reward...');
                audioEngine.playMagicalChime();
                this.createGroundParticles();

                const panel = document.createElement('a-entity');
                panel.setAttribute('position', '0 1.6 -5');
                panel.setAttribute('look-at', '[camera]');

                const bg = document.createElement('a-plane');
                bg.setAttribute('width', '5');
                bg.setAttribute('height', '3.5');
                bg.setAttribute('color', '#000000');
                bg.setAttribute('opacity', '0.95');
                bg.setAttribute('shadow', 'receive: true');
                panel.appendChild(bg);

                const border = document.createElement('a-plane');
                border.setAttribute('width', '5.2');
                border.setAttribute('height', '3.7');
                border.setAttribute('color', '#FFD700');
                border.setAttribute('opacity', '0.8');
                border.setAttribute('position', '0 0 -0.01');
                panel.appendChild(border);

                const title = document.createElement('a-text');
                title.setAttribute('value', 'üèÜ GEFELICITEERD VIBEKE!');
                title.setAttribute('align', 'center');
                title.setAttribute('color', '#00FF00');
                title.setAttribute('width', '4.5');
                title.setAttribute('position', '0 1.3 0.02');
                panel.appendChild(title);

                const reward = document.createElement('a-text');
                reward.setAttribute('value', 'DIT IS JE CADEAU!\n\nGraai nu met je handen naar onder\nin het zand om je schat te vinden.\n\n‚ú® GRAAIEN MAAR! ‚ú®');
                reward.setAttribute('align', 'center');
                reward.setAttribute('color', '#FFD700');
                reward.setAttribute('width', '4');
                reward.setAttribute('position', '0 0.3 0.02');
                reward.setAttribute('wrap-count', '35');
                panel.appendChild(reward);

                this.el.sceneEl.appendChild(panel);
                this.activeObjects.push(panel);
            },

            // =====================================================
            // VISUAL EFFECTS
            // =====================================================
            createExplosion: function(position, color, count = 50) {
                for (let i = 0; i < count; i++) {
                    const particle = document.createElement('a-sphere');
                    particle.setAttribute('radius', 0.06 + Math.random() * 0.08);
                    particle.setAttribute('color', color);
                    particle.setAttribute('position', position);

                    const vx = (Math.random() - 0.5) * 5;
                    const vy = Math.random() * 4 + 1;
                    const vz = (Math.random() - 0.5) * 5;

                    particle.setAttribute('animation__pos', {
                        property: 'position',
                        to: `${position.x + vx} ${position.y + vy} ${position.z + vz}`,
                        dur: 1800,
                        easing: 'easeOutQuad'
                    });

                    particle.setAttribute('animation__scale', {
                        property: 'scale',
                        to: '0 0 0',
                        dur: 1800,
                        easing: 'easeInQuad'
                    });

                    this.el.sceneEl.appendChild(particle);
                    setTimeout(() => {
                        if (particle.parentNode) particle.parentNode.removeChild(particle);
                    }, 1800);
                }
            },

            createGroundParticles: function() {
                const center = new THREE.Vector3(0, 0, 0.5);

                for (let i = 0; i < 80; i++) {
                    setTimeout(() => {
                        const particle = document.createElement('a-sphere');
                        particle.setAttribute('radius', 0.03 + Math.random() * 0.05);
                        particle.setAttribute('color', '#FFD700');
                        particle.setAttribute('material', 'emissive: #FFD700; emissiveIntensity: 0.8; metalness: 0.8');

                        const angle = Math.random() * Math.PI * 2;
                        const radius = Math.random() * 0.8;
                        const x = center.x + Math.cos(angle) * radius;
                        const z = center.z + Math.sin(angle) * radius;

                        particle.setAttribute('position', `${x} 0.05 ${z}`);

                        particle.setAttribute('animation__float', {
                            property: 'position',
                            to: `${x} ${0.5 + Math.random() * 0.3} ${z}`,
                            dur: 2000,
                            easing: 'easeOutQuad',
                            loop: false
                        });

                        particle.setAttribute('animation__fade', {
                            property: 'scale',
                            to: '0 0 0',
                            dur: 2000,
                            easing: 'easeInQuad',
                            loop: false
                        });

                        this.el.sceneEl.appendChild(particle);
                        setTimeout(() => {
                            if (particle.parentNode) particle.parentNode.removeChild(particle);
                        }, 2000);
                    }, i * 50);
                }
            }
        });

        console.log('‚úì All scripts loaded');
    </script>

</body>
</html>
