<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr. Oma's Expeditie - ULTIMATE HD</title>

    <!-- A-Frame Core -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <!-- A-Frame Extras (Animation Support) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>

    <!--
    =====================================================
    üì¶ REQUIRED ASSET FILES
    =====================================================

    Create folder: C:\Users\donku\assets\

    Download these files:

    CHARACTERS:
    - rhino.glb         (Animated rhino with Idle/Pain clips)
    - hunter.glb        (Animated humanoid with Idle/Attack clips)
    - spear.glb         (Tribal spear weapon)

    ENVIRONMENT:
    - tree.glb          (Acacia tree)
    - rock.glb          (Desert boulder)
    - grass.glb         (Grass tuft)

    TEXTURES:
    - sky.jpg           (360¬∞ equirectangular desert sky)
    - ground.jpg        (Sand texture, seamless, 1024x1024)

    DOWNLOAD SOURCES:
    - Sketchfab.com (search "low poly [name]", filter: Free + Downloadable)
    - Poly.pizza (Google Poly archive)
    - Unsplash.com (for sky.jpg - search "namibia desert sky")

    =====================================================
    -->

    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Arial Black', sans-serif;
        }
        #overlay {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #FFD700;
            font-family: 'Arial Black', sans-serif;
            font-size: 24px;
            text-shadow: 0 0 15px rgba(255, 215, 0, 1);
            z-index: 1000;
            pointer-events: none;
        }
        #hud {
            background: rgba(0, 0, 0, 0.85);
            padding: 25px;
            border-radius: 15px;
            border: 4px solid #FFD700;
            max-width: 450px;
            backdrop-filter: blur(10px);
        }
        .level-title {
            color: #FF6347;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .objective {
            color: #00FF00;
            font-size: 20px;
            margin: 10px 0;
        }
        .progress {
            color: #87CEEB;
            font-size: 28px;
            font-weight: bold;
        }
        #skip-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 30px;
            background: linear-gradient(135deg, #FF6347, #FF4500);
            border: 3px solid #FFD700;
            border-radius: 10px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            transition: all 0.3s;
        }
        #skip-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 30px rgba(255,99,71,0.8);
        }
    </style>
</head>
<body>
    <div id="overlay">
        <div id="hud">
            <div class="level-title" id="level-title">ü¶è DR. OMA'S EXPEDITIE HD</div>
            <div class="objective" id="objective">Namibian Steppe wordt geladen...</div>
            <div class="progress" id="progress"></div>
        </div>
    </div>

    <button id="skip-btn" onclick="window.gameManager.skipLevel()">‚è≠Ô∏è SKIP LEVEL</button>

    <a-scene
        webxr="optionalFeatures: hit-test;"
        cursor="rayOrigin: mouse"
        renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true; shadows: true"
        shadow="type: pcf; autoUpdate: true"
        fog="type: exponential; color: #E6D4B8; density: 0.015"
        loading-screen="dotsColor: #FFD700; backgroundColor: #1a1a1a">

        <!-- =====================================================
             ASSET MANAGEMENT
             ===================================================== -->
        <a-assets>
            <!-- Characters -->
            <a-asset-item id="rhino-asset" src="assets/rhino.glb" response-type="arraybuffer"></a-asset-item>
            <a-asset-item id="hunter-asset" src="assets/hunter.glb" response-type="arraybuffer"></a-asset-item>
            <a-asset-item id="spear-asset" src="assets/spear.glb" response-type="arraybuffer"></a-asset-item>

            <!-- Environment -->
            <a-asset-item id="tree-asset" src="assets/tree.glb" response-type="arraybuffer"></a-asset-item>
            <a-asset-item id="rock-asset" src="assets/rock.glb" response-type="arraybuffer"></a-asset-item>
            <a-asset-item id="grass-asset" src="assets/grass.glb" response-type="arraybuffer"></a-asset-item>

            <!-- Textures -->
            <img id="sky-asset" src="assets/sky.jpg" crossorigin="anonymous">
            <img id="ground-asset" src="assets/ground.jpg" crossorigin="anonymous">
        </a-assets>

        <!-- =====================================================
             ENVIRONMENT
             ===================================================== -->

        <!-- Skybox (360¬∞ Desert Sky) -->
        <a-sky
            src="#sky-asset"
            rotation="0 -90 0"
            material="shader: flat">
        </a-sky>

        <!-- Ground Plane (Massive desert floor) -->
        <a-plane
            id="ground"
            position="0 0 0"
            rotation="-90 0 0"
            width="100"
            height="100"
            material="src: #ground-asset; repeat: 50 50; roughness: 0.9; metalness: 0.1"
            shadow="receive: true">
        </a-plane>

        <!-- =====================================================
             LIGHTING (Realistic Desert Sun)
             ===================================================== -->

        <!-- Sun (Directional - casts shadows) -->
        <a-entity
            light="type: directional;
                   color: #FFF5CC;
                   intensity: 1.5;
                   castShadow: true;
                   shadowMapWidth: 2048;
                   shadowMapHeight: 2048;
                   shadowCameraFar: 50;
                   shadowCameraLeft: -20;
                   shadowCameraRight: 20;
                   shadowCameraTop: 20;
                   shadowCameraBottom: -20"
            position="-10 15 5">
        </a-entity>

        <!-- Ambient (Warm desert tone) -->
        <a-entity
            light="type: ambient;
                   color: #886644;
                   intensity: 0.6">
        </a-entity>

        <!-- Fill Light (Subtle) -->
        <a-entity
            light="type: point;
                   color: #FFE4B5;
                   intensity: 0.3;
                   distance: 20"
            position="5 3 -5">
        </a-entity>

        <!-- =====================================================
             CAMERA & CONTROLS
             ===================================================== -->

        <a-entity id="rig" position="0 0 0">
            <a-camera
                id="camera"
                position="0 1.6 5"
                look-controls
                wasd-controls="acceleration: 20">
                <a-cursor
                    color="#FFD700"
                    opacity="0.9"
                    raycaster="objects: .clickable; far: 150"
                    fuse="false"
                    animation__click="property: scale; startEvents: click; dur: 100; from: 0.1 0.1 0.1; to: 1 1 1">
                </a-cursor>
            </a-camera>
        </a-entity>

        <!-- =====================================================
             GAME MANAGER
             ===================================================== -->

        <a-entity id="game-manager" hd-game-manager steppe-generator></a-entity>

    </a-scene>

    <script>
        // =====================================================
        // AUDIO ENGINE
        // =====================================================
        class HDAudioEngine {
            constructor() {
                this.context = new (window.AudioContext || window.webkitAudioContext)();
                this.masterGain = this.context.createGain();
                this.masterGain.gain.value = 0.4;
                this.masterGain.connect(this.context.destination);
            }

            playHit() { this.playTone('square', 800, 0.2, 0.1); }
            playBlock() { this.playTone('triangle', 600, 0.25, 0.2); }
            playDamage() { this.playTone('sawtooth', 150, 0.3, 0.4); }
            playDrumBeat() { this.playTone('sawtooth', 60, 0.3, 0.15); }

            playSuccess() {
                const melody = [523.25, 659.25, 783.99, 1046.50];
                this.playMelody(melody, 150);
            }

            playVictory() {
                const melody = [523.25, 587.33, 659.25, 783.99, 880.00, 1046.50, 1174.66, 1318.51];
                this.playMelody(melody, 200);
            }

            playTone(type, freq, gain, duration) {
                const osc = this.context.createOscillator();
                const gainNode = this.context.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                gainNode.gain.setValueAtTime(gain, this.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + duration);
                osc.connect(gainNode);
                gainNode.connect(this.masterGain);
                osc.start();
                osc.stop(this.context.currentTime + duration);
            }

            playMelody(notes, interval) {
                notes.forEach((freq, i) => {
                    setTimeout(() => this.playTone('sine', freq, 0.15, 0.8), i * interval);
                });
            }

            resume() {
                if (this.context.state === 'suspended') this.context.resume();
            }
        }

        const audioEngine = new HDAudioEngine();

        // =====================================================
        // PHYSICS SYSTEM
        // =====================================================
        class PhysicsSystem {
            constructor() {
                this.gravity = -9.8;
            }

            applyGravity(entity, velocity, deltaTime) {
                velocity.y += this.gravity * deltaTime;

                const pos = entity.getAttribute('position');
                pos.x += velocity.x * deltaTime;
                pos.y += velocity.y * deltaTime;
                pos.z += velocity.z * deltaTime;

                entity.setAttribute('position', pos);

                // Rotate to face movement direction
                const angle = Math.atan2(velocity.y, Math.sqrt(velocity.x * velocity.x + velocity.z * velocity.z));
                const rotation = entity.getAttribute('rotation');
                rotation.x = THREE.MathUtils.radToDeg(angle);
                entity.setAttribute('rotation', rotation);

                return pos.y <= 0;
            }
        }

        const physics = new PhysicsSystem();

        // =====================================================
        // STEPPE GENERATOR (Procedural Environment)
        // =====================================================
        AFRAME.registerComponent('steppe-generator', {
            init: function() {
                console.log('üåç Generating Namibian Steppe...');

                setTimeout(() => {
                    this.generateSteppe();
                }, 1000);
            },

            generateSteppe: function() {
                const scene = this.el.sceneEl;

                // Check asset availability
                const hasTree = document.getElementById('tree-asset');
                const hasRock = document.getElementById('rock-asset');
                const hasGrass = document.getElementById('grass-asset');

                // Trees (Acacia)
                const treeCount = hasTree ? 20 : 0;
                for (let i = 0; i < treeCount; i++) {
                    this.spawnTree();
                }

                // Rocks (Boulders)
                const rockCount = hasRock ? 15 : 0;
                for (let i = 0; i < rockCount; i++) {
                    this.spawnRock();
                }

                // Grass Tufts
                const grassCount = hasGrass ? 50 : 0;
                for (let i = 0; i < grassCount; i++) {
                    this.spawnGrass();
                }

                console.log(`‚úì Spawned: ${treeCount} trees, ${rockCount} rocks, ${grassCount} grass`);
            },

            getRandomPositionInDonut: function(innerRadius, outerRadius) {
                const angle = Math.random() * Math.PI * 2;
                const radius = innerRadius + Math.random() * (outerRadius - innerRadius);
                return {
                    x: Math.cos(angle) * radius,
                    z: Math.sin(angle) * radius
                };
            },

            spawnTree: function() {
                const tree = document.createElement('a-entity');
                const pos = this.getRandomPositionInDonut(8, 25);

                tree.setAttribute('position', `${pos.x} 0 ${pos.z}`);
                tree.setAttribute('rotation', `0 ${Math.random() * 360} 0`);
                tree.setAttribute('scale', {
                    x: 0.8 + Math.random() * 0.4,
                    y: 0.8 + Math.random() * 0.4,
                    z: 0.8 + Math.random() * 0.4
                });
                tree.setAttribute('gltf-model', '#tree-asset');
                tree.setAttribute('shadow', 'cast: true; receive: true');

                this.el.sceneEl.appendChild(tree);
            },

            spawnRock: function() {
                const rock = document.createElement('a-entity');
                const pos = this.getRandomPositionInDonut(6, 25);

                rock.setAttribute('position', `${pos.x} 0 ${pos.z}`);
                rock.setAttribute('rotation', `0 ${Math.random() * 360} 0`);
                rock.setAttribute('scale', {
                    x: 0.7 + Math.random() * 0.6,
                    y: 0.7 + Math.random() * 0.6,
                    z: 0.7 + Math.random() * 0.6
                });
                rock.setAttribute('gltf-model', '#rock-asset');
                rock.setAttribute('shadow', 'cast: true; receive: true');

                this.el.sceneEl.appendChild(rock);
            },

            spawnGrass: function() {
                const grass = document.createElement('a-entity');
                const pos = this.getRandomPositionInDonut(4, 30);

                grass.setAttribute('position', `${pos.x} 0 ${pos.z}`);
                grass.setAttribute('rotation', `0 ${Math.random() * 360} 0`);
                grass.setAttribute('scale', {
                    x: 0.5 + Math.random() * 0.5,
                    y: 0.5 + Math.random() * 0.5,
                    z: 0.5 + Math.random() * 0.5
                });
                grass.setAttribute('gltf-model', '#grass-asset');

                this.el.sceneEl.appendChild(grass);
            }
        });

        // =====================================================
        // GAME STATES
        // =====================================================
        const GAME_STATES = {
            INTRO: 'intro',
            LEVEL_1: 'level_1',
            LEVEL_2: 'level_2',
            LEVEL_3: 'level_3',
            VICTORY: 'victory'
        };

        // =====================================================
        // HD GAME MANAGER
        // =====================================================
        AFRAME.registerComponent('hd-game-manager', {
            init: function() {
                this.currentState = GAME_STATES.INTRO;
                this.level1Score = 0;
                this.level1Target = 5;
                this.level2Score = 0;
                this.level2Target = 5;
                this.level3Complete = false;

                this.activeObjects = [];
                this.physicsObjects = [];
                this.camera = document.querySelector('#camera');

                // Asset availability
                this.hasRhino = !!document.getElementById('rhino-asset');
                this.hasHunter = !!document.getElementById('hunter-asset');
                this.hasSpear = !!document.getElementById('spear-asset');

                window.gameManager = this;

                setTimeout(() => this.startIntro(), 2000);
            },

            tick: function(time, deltaTime) {
                const dt = deltaTime / 1000;

                this.physicsObjects.forEach(obj => {
                    if (obj.userData && obj.userData.velocity) {
                        const hitGround = physics.applyGravity(obj, obj.userData.velocity, dt);

                        if (hitGround && obj.parentNode) {
                            obj.parentNode.removeChild(obj);
                            this.physicsObjects = this.physicsObjects.filter(o => o !== obj);
                        }
                    }
                });
            },

            skipLevel: function() {
                switch(this.currentState) {
                    case GAME_STATES.INTRO: this.startLevel1(); break;
                    case GAME_STATES.LEVEL_1: this.completeLevel1(); break;
                    case GAME_STATES.LEVEL_2: this.completeLevel2(); break;
                    case GAME_STATES.LEVEL_3: this.completeLevel3(); break;
                    case GAME_STATES.VICTORY: location.reload(); break;
                }
            },

            startIntro: function() {
                this.currentState = GAME_STATES.INTRO;
                this.updateHUD('ü¶è DR. OMA\'S EXPEDITIE HD', 'KLIK OM TE STARTEN', '');

                const panel = this.createClickablePanel(
                    'MISSIE BRIEFING\n\nWelkom in de Namibische Steppe!\n\n' +
                    '3D Assets:\n' +
                    (this.hasRhino ? '‚úì' : '‚úó') + ' Neushoorn\n' +
                    (this.hasHunter ? '‚úì' : '‚úó') + ' Jagers\n' +
                    (this.hasSpear ? '‚úì' : '‚úó') + ' Speren\n\n' +
                    'Niveau 1: Verdedig Wetenschap\n' +
                    'Niveau 2: Blokkeer Speren\n' +
                    'Niveau 3: Operatie\n\n' +
                    '>>> KLIK HIER <<<',
                    '#00FF00',
                    4,
                    () => this.startLevel1()
                );
            },

            startLevel1: function() {
                this.currentState = GAME_STATES.LEVEL_1;
                this.level1Score = 0;
                this.clearAllObjects();

                this.updateHUD('üåë NIVEAU 1', 'KLIK rode Flat Earths!', `${this.level1Score} / ${this.level1Target}`);

                for (let i = 0; i < 10; i++) {
                    setTimeout(() => {
                        if (this.currentState === GAME_STATES.LEVEL_1) {
                            this.spawnLevel1Object((Math.PI * 2 / 10) * i);
                        }
                    }, i * 800);
                }
            },

            spawnLevel1Object: function(angle) {
                const isFake = Math.random() < 0.6;
                const obj = document.createElement('a-entity');

                const radius = 4;
                const height = 1.5;
                const x = Math.cos(angle) * radius;
                const z = Math.sin(angle) * radius;

                obj.setAttribute('position', `${x} ${height} ${z}`);
                obj.classList.add('level1-object', 'clickable');
                obj.setAttribute('data-type', isFake ? 'fake' : 'truth');

                if (isFake) {
                    const cylinder = document.createElement('a-cylinder');
                    cylinder.setAttribute('radius', '0.5');
                    cylinder.setAttribute('height', '0.12');
                    cylinder.setAttribute('color', '#DC143C');
                    cylinder.setAttribute('metalness', '0.4');
                    cylinder.setAttribute('roughness', '0.6');
                    cylinder.setAttribute('shadow', 'cast: true');
                    obj.appendChild(cylinder);
                } else {
                    const sphere = document.createElement('a-sphere');
                    sphere.setAttribute('radius', '0.4');
                    sphere.setAttribute('color', '#1E90FF');
                    sphere.setAttribute('metalness', '0.6');
                    sphere.setAttribute('roughness', '0.3');
                    sphere.setAttribute('shadow', 'cast: true');
                    obj.appendChild(sphere);
                }

                const text = document.createElement('a-text');
                text.setAttribute('value', isFake ? 'FAKE' : 'TRUTH');
                text.setAttribute('align', 'center');
                text.setAttribute('color', '#FFFFFF');
                text.setAttribute('width', '3');
                text.setAttribute('position', `0 ${isFake ? 0.3 : 0.6} 0`);
                text.setAttribute('look-at', '[camera]');
                obj.appendChild(text);

                obj.setAttribute('animation', {
                    property: 'rotation',
                    to: '0 360 0',
                    dur: 10000,
                    loop: true,
                    easing: 'linear'
                });

                obj.addEventListener('click', () => this.handleLevel1Hit(obj));

                this.el.sceneEl.appendChild(obj);
                this.activeObjects.push(obj);
            },

            handleLevel1Hit: function(obj) {
                const type = obj.getAttribute('data-type');

                if (type === 'fake') {
                    this.level1Score++;
                    audioEngine.playHit();
                    this.updateHUD('üåë NIVEAU 1', '‚úì GOED!', `${this.level1Score} / ${this.level1Target}`);
                    this.createExplosion(obj.object3D.position, '#FF6347', 40);

                    if (this.level1Score >= this.level1Target) {
                        this.completeLevel1();
                    }
                } else {
                    audioEngine.playDamage();
                    this.flashScreen('#FF0000');
                }

                if (obj.parentNode) {
                    obj.parentNode.removeChild(obj);
                    this.activeObjects = this.activeObjects.filter(o => o !== obj);
                }
            },

            completeLevel1: function() {
                this.clearAllObjects();
                audioEngine.playSuccess();
                this.updateHUD('‚úì NIVEAU 1 VOLTOOID!', 'Volgende...', '');
                setTimeout(() => this.startLevel2(), 2000);
            },

            startLevel2: function() {
                this.currentState = GAME_STATES.LEVEL_2;
                this.level2Score = 0;
                this.clearAllObjects();

                this.updateHUD('üèπ NIVEAU 2', 'KLIK speren!', `${this.level2Score} / ${this.level2Target}`);

                this.level2DrumInterval = setInterval(() => {
                    if (this.currentState === GAME_STATES.LEVEL_2) {
                        audioEngine.playDrumBeat();
                    }
                }, 800);

                for (let i = 0; i < 8; i++) {
                    setTimeout(() => {
                        if (this.currentState === GAME_STATES.LEVEL_2) {
                            this.spawnSpear((Math.PI * 2 / 8) * i);
                        }
                    }, i * 1500);
                }
            },

            spawnSpear: function(angle) {
                const spear = document.createElement('a-entity');

                const radius = 5;
                const height = 2.5;
                const x = Math.cos(angle) * radius;
                const z = Math.sin(angle) * radius;

                spear.setAttribute('position', `${x} ${height} ${z}`);
                spear.classList.add('level2-spear', 'clickable');
                spear.setAttribute('shadow', 'cast: true');

                if (this.hasSpear) {
                    spear.setAttribute('gltf-model', '#spear-asset');
                    spear.setAttribute('scale', '0.8 0.8 0.8');
                } else {
                    const shaft = document.createElement('a-cylinder');
                    shaft.setAttribute('radius', '0.04');
                    shaft.setAttribute('height', '2');
                    shaft.setAttribute('color', '#8B4513');
                    shaft.setAttribute('rotation', '0 0 90');
                    shaft.setAttribute('metalness', '0.2');
                    shaft.setAttribute('roughness', '0.8');
                    spear.appendChild(shaft);

                    const tip = document.createElement('a-cone');
                    tip.setAttribute('radius-bottom', '0.1');
                    tip.setAttribute('height', '0.3');
                    tip.setAttribute('color', '#C0C0C0');
                    tip.setAttribute('position', '1 0 0');
                    tip.setAttribute('rotation', '0 0 -90');
                    tip.setAttribute('metalness', '0.8');
                    tip.setAttribute('roughness', '0.3');
                    spear.appendChild(tip);
                }

                spear.setAttribute('look-at', '[camera]');

                // Physics
                const cameraPos = this.camera.object3D.position;
                const direction = new THREE.Vector3(
                    cameraPos.x - x,
                    cameraPos.y - height + 3,
                    cameraPos.z - z
                ).normalize();

                spear.userData = {
                    velocity: {
                        x: direction.x * 4,
                        y: direction.y * 4 + 2.5,
                        z: direction.z * 4
                    }
                };

                spear.addEventListener('click', () => this.handleLevel2Block(spear));

                this.el.sceneEl.appendChild(spear);
                this.activeObjects.push(spear);
                this.physicsObjects.push(spear);
            },

            handleLevel2Block: function(spear) {
                this.level2Score++;
                audioEngine.playBlock();
                this.updateHUD('üèπ NIVEAU 2', '‚úì GEBLOKEERD!', `${this.level2Score} / ${this.level2Target}`);
                this.createExplosion(spear.object3D.position, '#FFD700', 25);

                if (spear.parentNode) {
                    spear.parentNode.removeChild(spear);
                    this.activeObjects = this.activeObjects.filter(o => o !== spear);
                    this.physicsObjects = this.physicsObjects.filter(o => o !== spear);
                }

                if (this.level2Score >= this.level2Target) {
                    this.completeLevel2();
                }
            },

            completeLevel2: function() {
                clearInterval(this.level2DrumInterval);
                this.clearAllObjects();
                audioEngine.playSuccess();
                this.updateHUD('‚úì NIVEAU 2 VOLTOOID!', 'Ziekenboeg...', '');
                setTimeout(() => this.startLevel3(), 2000);
            },

            startLevel3: function() {
                this.currentState = GAME_STATES.LEVEL_3;
                this.clearAllObjects();
                this.updateHUD('ü¶è NIVEAU 3', 'KLIK de TUMOR!', '');
                this.spawnRhino();
            },

            spawnRhino: function() {
                const rhinoContainer = document.createElement('a-entity');
                rhinoContainer.setAttribute('id', 'rhino-boss');
                rhinoContainer.setAttribute('position', '0 1 -4');
                rhinoContainer.setAttribute('shadow', 'cast: true; receive: true');

                if (this.hasRhino) {
                    const rhino = document.createElement('a-entity');
                    rhino.setAttribute('gltf-model', '#rhino-asset');
                    rhino.setAttribute('scale', '2 2 2');
                    rhino.setAttribute('animation-mixer', 'clip: Idle; loop: repeat; timeScale: 0.4');

                    // Breathing animation
                    rhino.setAttribute('animation__breath', {
                        property: 'scale',
                        from: '2 2 2',
                        to: '2.05 2.05 2.05',
                        dur: 3000,
                        loop: true,
                        dir: 'alternate',
                        easing: 'easeInOutSine'
                    });

                    rhinoContainer.appendChild(rhino);
                } else {
                    // Fallback
                    const body = document.createElement('a-box');
                    body.setAttribute('width', '2');
                    body.setAttribute('height', '1.2');
                    body.setAttribute('depth', '1');
                    body.setAttribute('color', '#696969');
                    body.setAttribute('opacity', '0.5');
                    body.setAttribute('material', 'transparent: true; metalness: 0.3; roughness: 0.7');
                    rhinoContainer.appendChild(body);
                }

                // Tumor
                const tumor = document.createElement('a-sphere');
                tumor.setAttribute('radius', '0.25');
                tumor.setAttribute('color', '#DC143C');
                tumor.setAttribute('position', '0.5 0 0');
                tumor.setAttribute('id', 'tumor');
                tumor.classList.add('tumor', 'clickable');
                tumor.setAttribute('material', 'emissive: #FF0000; emissiveIntensity: 0.8; metalness: 0.5; roughness: 0.3');
                tumor.setAttribute('shadow', 'cast: true');

                tumor.setAttribute('animation', {
                    property: 'scale',
                    from: '1 1 1',
                    to: '1.5 1.5 1.5',
                    dur: 1000,
                    loop: true,
                    dir: 'alternate',
                    easing: 'easeInOutSine'
                });

                tumor.addEventListener('click', () => this.handleTumorGrab(tumor));
                rhinoContainer.appendChild(tumor);

                this.el.sceneEl.appendChild(rhinoContainer);
                this.activeObjects.push(rhinoContainer);
            },

            handleTumorGrab: function(tumor) {
                this.level3Complete = true;
                audioEngine.playSuccess();
                this.updateHUD('‚úì OPERATIE GESLAAGD!', 'Tumor verwijderd!', '');

                tumor.setAttribute('animation__extract', {
                    property: 'position',
                    to: '0.5 4 0',
                    dur: 2000,
                    easing: 'easeOutQuad'
                });

                tumor.setAttribute('animation__scale', {
                    property: 'scale',
                    to: '0 0 0',
                    dur: 2000,
                    easing: 'easeInQuad'
                });

                setTimeout(() => {
                    if (tumor.parentNode) tumor.parentNode.removeChild(tumor);
                    this.completeLevel3();
                }, 2000);
            },

            completeLevel3: function() {
                this.clearAllObjects();
                setTimeout(() => this.startVictory(), 2000);
            },

            startVictory: function() {
                this.currentState = GAME_STATES.VICTORY;
                audioEngine.playVictory();
                this.updateHUD('üèÜ MISSIE VOLTOOID!', 'Alle levels!', '');

                for (let i = 0; i < 10; i++) {
                    setTimeout(() => {
                        const pos = new THREE.Vector3(
                            (Math.random() - 0.5) * 8,
                            2 + Math.random() * 4,
                            -4 - Math.random() * 3
                        );
                        this.createExplosion(pos, ['#FFD700', '#FF6347', '#00FF00', '#87CEEB', '#FF69B4'][i % 5], 70);
                    }, i * 700);
                }

                setTimeout(() => this.showFinalReward(), 4000);
            },

            showFinalReward: function() {
                const panel = document.createElement('a-entity');
                panel.setAttribute('position', '0 1.6 -4.5');
                panel.setAttribute('look-at', '[camera]');

                const bg = document.createElement('a-plane');
                bg.setAttribute('width', '4');
                bg.setAttribute('height', '2.8');
                bg.setAttribute('color', '#000000');
                bg.setAttribute('opacity', '0.95');
                bg.setAttribute('shadow', 'receive: true');
                panel.appendChild(bg);

                const border = document.createElement('a-plane');
                border.setAttribute('width', '4.1');
                border.setAttribute('height', '2.9');
                border.setAttribute('color', '#FFD700');
                border.setAttribute('opacity', '0.7');
                border.setAttribute('position', '0 0 -0.01');
                panel.appendChild(border);

                const title = document.createElement('a-text');
                title.setAttribute('value', 'MISSIE VOLTOOID!');
                title.setAttribute('align', 'center');
                title.setAttribute('color', '#00FF00');
                title.setAttribute('width', '3.5');
                title.setAttribute('position', '0 1 0.02');
                panel.appendChild(title);

                const reward = document.createElement('a-text');
                reward.setAttribute('value', 'LOCATIE CADEAU:\n\nIN DE ZANDBAK\n\n(Graaien maar!)');
                reward.setAttribute('align', 'center');
                reward.setAttribute('color', '#FFD700');
                reward.setAttribute('width', '3.2');
                reward.setAttribute('position', '0 0.3 0.02');
                reward.setAttribute('wrap-count', '30');
                panel.appendChild(reward);

                // 3D Book
                const book = document.createElement('a-box');
                book.setAttribute('width', '0.6');
                book.setAttribute('height', '0.8');
                book.setAttribute('depth', '0.12');
                book.setAttribute('color', '#8B4513');
                book.setAttribute('position', '0 -0.9 0.2');
                book.setAttribute('material', 'roughness: 0.9; metalness: 0.1');
                book.setAttribute('shadow', 'cast: true');

                book.setAttribute('animation__float', {
                    property: 'position',
                    to: '0 -0.7 0.2',
                    dur: 3000,
                    loop: true,
                    dir: 'alternate',
                    easing: 'easeInOutSine'
                });

                book.setAttribute('animation__rotate', {
                    property: 'rotation',
                    to: '0 360 0',
                    dur: 10000,
                    loop: true,
                    easing: 'linear'
                });

                panel.appendChild(book);

                this.el.sceneEl.appendChild(panel);
            },

            // Utilities
            updateHUD: function(title, objective, progress) {
                document.getElementById('level-title').textContent = title;
                document.getElementById('objective').textContent = objective;
                document.getElementById('progress').textContent = progress;
            },

            createClickablePanel: function(text, color, width, onClick) {
                const panel = document.createElement('a-entity');
                panel.setAttribute('position', '0 1.6 -4');
                panel.setAttribute('look-at', '[camera]');
                panel.classList.add('clickable');

                const bg = document.createElement('a-plane');
                bg.setAttribute('width', width);
                bg.setAttribute('height', '3');
                bg.setAttribute('color', '#000000');
                bg.setAttribute('opacity', '0.92');
                panel.appendChild(bg);

                const textEl = document.createElement('a-text');
                textEl.setAttribute('value', text);
                textEl.setAttribute('align', 'center');
                textEl.setAttribute('color', color);
                textEl.setAttribute('width', width - 0.5);
                textEl.setAttribute('position', '0 0 0.02');
                textEl.setAttribute('wrap-count', '45');
                panel.appendChild(textEl);

                panel.addEventListener('click', () => {
                    if (panel.parentNode) panel.parentNode.removeChild(panel);
                    if (onClick) onClick();
                });

                this.el.sceneEl.appendChild(panel);
                return panel;
            },

            createExplosion: function(position, color, count = 50) {
                for (let i = 0; i < count; i++) {
                    const particle = document.createElement('a-sphere');
                    particle.setAttribute('radius', 0.05 + Math.random() * 0.06);
                    particle.setAttribute('color', color);
                    particle.setAttribute('position', position);

                    const vx = (Math.random() - 0.5) * 4;
                    const vy = Math.random() * 3 + 0.5;
                    const vz = (Math.random() - 0.5) * 4;

                    particle.setAttribute('animation__pos', {
                        property: 'position',
                        to: `${position.x + vx} ${position.y + vy} ${position.z + vz}`,
                        dur: 1500,
                        easing: 'easeOutQuad'
                    });

                    particle.setAttribute('animation__scale', {
                        property: 'scale',
                        to: '0 0 0',
                        dur: 1500,
                        easing: 'easeInQuad'
                    });

                    this.el.sceneEl.appendChild(particle);
                    setTimeout(() => {
                        if (particle.parentNode) particle.parentNode.removeChild(particle);
                    }, 1500);
                }
            },

            flashScreen: function(color) {
                const flash = document.createElement('a-plane');
                flash.setAttribute('width', '100');
                flash.setAttribute('height', '100');
                flash.setAttribute('color', color);
                flash.setAttribute('opacity', '0.7');
                flash.setAttribute('position', '0 1.6 -1');

                flash.setAttribute('animation__fade', {
                    property: 'material.opacity',
                    from: 0.7,
                    to: 0,
                    dur: 700
                });

                this.el.sceneEl.appendChild(flash);
                setTimeout(() => {
                    if (flash.parentNode) flash.parentNode.removeChild(flash);
                }, 700);
            },

            clearAllObjects: function() {
                this.activeObjects.forEach(obj => {
                    if (obj.parentNode) obj.parentNode.removeChild(obj);
                });
                this.activeObjects = [];
                this.physicsObjects = [];
            }
        });

        document.addEventListener('click', () => audioEngine.resume(), { once: true });
    </script>
</body>
</html>
